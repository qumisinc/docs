# Qumis Documentation â€” Engineering

Expert AI built for the top minds in insurance. Attorney-trained AI that delivers clarity, speed, and legal-grade reasoning for the industry's most complex risks.

---

# Engineering Documentation

Source: internal/engineering/index

Welcome to the Qumis engineering documentation hub. This is your central resource for deployment procedures, infrastructure management, and development workflows.

> **Tip:** **Quick Reference:** [Deployment Cheatsheet](/internal/engineering/deployment/deployment-cheatsheet) - Copy-paste production commands
>
> **Most Used:** [Production Deployment](/internal/engineering/deployment/production-deployment) | [qumis-cli Reference](/internal/engineering/operations/qumis-cli-reference) | [AWS Environments](/internal/engineering/infrastructure/aws-environments)

## Quick Start

Complete onboarding checklist

Step-by-step deployment guide

Track deployments and changes

Video walkthroughs and written guides

SSO login for all environments

## Core Operations

### Deployment

> **Note:** **Quick Start:** Use the [Deployment Cheatsheet](/internal/engineering/deployment/deployment-cheatsheet) for copy-paste production commands.

Quick reference with copy-paste production commands

Deploy services to production with safety checks

Pre and post-deployment verification steps

Validate deployment success and system health

Emergency rollback and recovery procedures

### Operations & Tools

Complete command-line tool documentation

Execute Rails commands on API service

Run Playwright + Chromatic tests for qumis-web

## Infrastructure & Monitoring

### AWS Infrastructure

Complete guide to all AWS environments

Monitor logs and application metrics

Configure and manage alerts

## Development Workflow

### Setup Development Environment

Install [qumis-cli and other essential tools](/internal/engineering/tools-setup) for daily development work

### Learn Git Workflow

Review our [Git branching strategies](/internal/engineering/guides/git-branching-strategies) to understand our development process

### Start Contributing

Follow the team conventions and begin contributing to the codebase

## Troubleshooting & Support

Solutions to frequently encountered problems

Safe debugging techniques for production

> **Warning:** **Production Issues?** Check [Common Issues](/internal/engineering/troubleshooting/common-issues) first, then reach out in #engineering on Slack if you need help.

## Resources & Links

CLI tool source code and issues

Access all AWS environments

Team communication channel

Current system health and incidents

## Need Help?

- **Slack**: #engineering channel for general questions
- **Urgent Issues**: Page the on-call engineer via PagerDuty
- **Documentation Issues**: Submit a PR or reach out to the documentation team

---

# Engineering Onboarding

Source: internal/engineering/onboarding

Welcome to the Qumis engineering team! This guide will help you get set up with all the tools and access you need.

## Prerequisites

Before starting, ensure you have:

- GitHub account with access to Qumis repositories
- AWS account setup (coordinate with team lead)
- Slack access to the engineering channels

> **Tip:** **AWS Console Access**: Once your AWS account is set up, you can access all environments through the AWS SSO portal:
>
> [**https://qumis.awsapps.com/start/#/?tab=accounts**](https://qumis.awsapps.com/start/#/?tab=accounts)
>
> Bookmark this URL for quick access to all AWS environments.

## Day 1: Essential Setup

### Install Development Tools

Install the core development tools:

```bash
# Install Homebrew (macOS)
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Install essential tools
brew install git gh tree
brew install pygitup  # Highly recommended for git sync
```

### Install qumis-cli

Clone and install our internal CLI tool:

```bash
git clone https://github.com/qumisinc/qumis-cli.git
cd qumis-cli
make deploy

# Verify installation
qumis --version
```

See [Tools Setup](/internal/engineering/tools-setup) for detailed instructions.

### Configure AWS Access

Set up AWS CLI and profiles:

```bash
# Install AWS CLI
brew install awscli
```

**AWS SSO Portal Access**: [https://qumis.awsapps.com/start/#/?tab=accounts](https://qumis.awsapps.com/start/#/?tab=accounts)

Create your `~/.aws/config` file with this quick-start template for CLI access:

```ini
# AWS SSO configuration
[sso-session qumis_sso]
sso_start_url = https://qumis.awsapps.com/start/
sso_region = us-east-2
sso_registration_scopes = sso:account:access

[default]

[profile qumis_dev]
sso_session = qumis_sso
sso_account_id = 080970846004
sso_role_name = AdministratorAccess
region = us-east-2
output = json

[profile qumis_qa]
sso_session = qumis_sso
sso_account_id = 340452546718
sso_role_name = AdministratorAccess
region = us-east-2
output = json

[profile qumis_uat]
sso_session = qumis_sso
sso_account_id = 499854674638
sso_role_name = AdministratorAccess
region = us-east-2
output = json

[profile qumis_prod]
sso_session = qumis_sso
sso_account_id = 729033428609
sso_role_name = AdministratorAccess
region = us-east-2
output = json
```

> **Info:** For the **complete AWS configuration** with detailed comments and all profiles (including Shared Services), see [Tools Setup â†’ AWS Configuration](/internal/engineering/tools-setup#aws-configuration).

### Clone Core Repositories

Clone the main repositories:

```bash
# API Repository
git clone https://github.com/qumisinc/qumis-api.git

# Web Application
git clone https://github.com/qumisinc/qumis-web.git

# Infrastructure
git clone https://github.com/qumisinc/qumis-infra.git

# Documentation
git clone https://github.com/qumisinc/qumis-docs.git
```

## Day 2: Environment Configuration

### Configure qumis-cli

Set up your GitHub and Linear tokens:

```bash
# Generate GitHub token at: https://github.com/settings/tokens
# Scopes needed: repo, workflow
qumis config github.token <your-github-token>

# Get Linear API key from: https://linear.app/settings/api
qumis config linear.token <your-linear-api-key>

# Verify configuration
qumis doctor
```

### Set Up Local Development

For API development:

```bash
cd qumis-api
# Follow README.md for local setup
bundle install
rails db:setup
```

For web development:

```bash
cd qumis-web
# Follow README.md for local setup
npm install
npm run dev
```

### Test AWS Access

Verify your AWS access:

```bash
# Login to development environment
qumis aws login dev

# List Lambda functions
qumis lambda list-functions --env dev

# View CloudWatch logs (if you have access)
aws logs tail /aws/lambda/qumis-api --profile qumis_dev
```

## Day 3-5: Learn the Workflow

### Development Workflow

### Create a feature branch

```bash
qumis feature my-feature --ticket ENG-123
```

### Keep your branch updated

```bash
qumis sync
```

### Create a pull request

```bash
qumis pr create --title "Add new feature"
```

### Deployment Process

> **Warning:** Never deploy to production without:
>
> - Code review approval
> - QA testing in UAT environment
> - Team lead approval

Learn about our deployment process:

- [Production Deployment Guide](/internal/engineering/deployment/production-deployment)
- [Deployment Checklist](/internal/engineering/deployment/deployment-checklist)

### Monitoring & Debugging

Get familiar with our monitoring tools:

- [CloudWatch Monitoring](/internal/engineering/infrastructure/cloudwatch-monitoring)
- [CloudWatch Alerts](/internal/engineering/infrastructure/cloudwatch-alerts)

## Access Checklist

Ensure you have access to:

- \[ ] GitHub repositories (qumis org)
- \[ ] AWS Console (at least dev environment)
- \[ ] Linear (project management)
- \[ ] Slack channels (#engineering, #deployments, #alerts)
- \[ ] PagerDuty (for on-call rotation)
- \[ ] 1Password (team vault)

## Related Documentation

Detailed qumis-cli and development tools installation

Keep your feature branches in sync

Deploy safely to production

## Resources

### Documentation

- [qumis-cli Reference](/internal/engineering/operations/qumis-cli-reference)
- [Git Branching Strategies](/internal/engineering/guides/git-branching-strategies)
- [Rails Commands Guide](/internal/engineering/operations/rails-commands)

### Key Repositories

- [qumis-cli](https://github.com/qumisinc/qumis-cli) - Internal CLI tool
- [qumis-api](https://github.com/qumisinc/qumis-api) - Rails API
- [qumis-web](https://github.com/qumisinc/qumis-web) - Web application
- [qumis-infra](https://github.com/qumisinc/qumis-infra) - Infrastructure code

### Support Channels

- **Slack**: #engineering for questions
- **Wiki**: Internal wiki for detailed guides
- **Mentor**: Your assigned onboarding buddy

## First Week Goals

By the end of your first week, you should:

- âœ… Have all tools installed and configured
- âœ… Successfully run the application locally
- âœ… Deploy a change to the dev environment
- âœ… Understand our Git workflow
- âœ… Know how to monitor logs in CloudWatch
- âœ… Be familiar with qumis-cli commands

## Questions?

Don't hesitate to ask questions in #engineering or reach out to your onboarding buddy. We're here to help you succeed!

---

# Tools Setup

Source: internal/engineering/tools-setup

This guide covers the installation and configuration of all essential tools for Qumis development.

## qumis-cli Installation

> **Info:** **qumis-cli** is our internal CLI tool that streamlines development workflows, deployments, and operations.
>
> Repository: [github.com/qumisinc/qumis-cli](https://github.com/qumisinc/qumis-cli) (Private)

### Prerequisites for qumis-cli

```bash
# Check Go version (need 1.21+)
go version

# If Go is not installed or outdated:
brew install go
# OR use asdf for version management:
asdf plugin-add golang
asdf install golang 1.21.0
asdf global golang 1.21.0
```

### Install qumis-cli

```bash Full Install (Recommended)
# Clone the repository
git clone https://github.com/qumisinc/qumis-cli.git
cd qumis-cli

# Build and install
make deploy

# Verify installation
qumis --version

# Add shell integration to your ~/.zshrc or ~/.bashrc
echo "source $(pwd)/shell/qumis.sh" >> ~/.zshrc
source ~/.zshrc
```

```bash Binary Only
git clone https://github.com/qumisinc/qumis-cli.git /tmp/qumis-cli && \
cd /tmp/qumis-cli && \
make deploy && \
cd - && \
rm -rf /tmp/qumis-cli
```

> **Note:** **Full Install** includes shell integration with helpful aliases and completions. **Binary Only** is faster but lacks these conveniences.

### Configure qumis-cli

### Generate GitHub Token

1. Go to [GitHub Settings â†’ Developer settings â†’ Personal access tokens](https://github.com/settings/tokens)
2. Click "Generate new token (classic)"
3. Select scopes: `repo` and `workflow`
4. Generate and copy the token

```bash
qumis config github.token <your-github-token>
```

### Configure Linear API Key

1. Go to [Linear Settings â†’ API](https://linear.app/settings/api)
2. Create a new personal API key
3. Copy the key

```bash
qumis config linear.token <your-linear-api-key>
```

### Verify Configuration

Run the diagnostic command:

```bash
qumis doctor
```

This should show all green checkmarks for configured services.

## Essential Development Tools

### Required Tools

```bash
# Package managers and version control
brew install git gh

# Highly recommended for git operations
brew install pygitup  # For smart git sync

# AWS CLI for cloud operations
brew install awscli

# Directory visualization
brew install tree
```

### Node.js Installation

```bash Homebrew (Simple)
brew install node
```

```bash nvm (Version Management)
# Install nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# Install and use Node.js 20
nvm install 20
nvm use 20
```

> **Tip:** Use **nvm** if you need to manage multiple Node.js versions across different projects. Use **Homebrew** for a simpler single-version setup.

### Optional but Recommended

```bash
# Linear CLI for ticket management
brew install schpet/tap/linear

# Repository packing for AI tools
brew install repomix

# JSON processing
brew install jq

# HTTP client for API testing
brew install httpie

# Docker for containerized development
brew install --cask docker
```

## AWS Configuration

### Configure AWS SSO

### Install AWS CLI

```bash
brew install awscli
```

### Configure AWS Profiles

Create or update your `~/.aws/config` file with the following configuration:

```ini
# AWS Configuration for Qumis
# ================================
# AWS CLI configuration file
# Location: ~/.aws/config
#
# After updating this file, authenticate with: aws sso login --profile qumis_<env>
# Example: aws sso login --profile qumis_prod

# AWS SSO Session Configuration
# --------------------------------
# Shared SSO session used by all Qumis AWS profiles
[sso-session qumis_sso]
sso_start_url = https://qumis.awsapps.com/start/
sso_region = us-east-2
sso_registration_scopes = sso:account:access

# Default Profile
# --------------------------------
[default]

# Development Environment
# --------------------------------
# Account: 080970846004
# Region: us-east-2
# Use: Local development and testing
[profile qumis_dev]
sso_session = qumis_sso
sso_account_id = 080970846004
sso_role_name = AdministratorAccess
region = us-east-2
output = json

# QA Environment
# --------------------------------
# Account: 340452546718
# Region: us-east-2
# Use: Quality assurance testing
[profile qumis_qa]
sso_session = qumis_sso
sso_account_id = 340452546718
sso_role_name = AdministratorAccess
region = us-east-2
output = json

# UAT Environment
# --------------------------------
# Account: 499854674638
# Region: us-east-2
# Use: User acceptance testing (pre-production)
[profile qumis_uat]
sso_session = qumis_sso
sso_account_id = 499854674638
sso_role_name = AdministratorAccess
region = us-east-2
output = json

# Production Environment
# --------------------------------
# Account: 729033428609
# Region: us-east-2
# Use: Production deployments and operations
# WARNING: Exercise caution when using this profile
[profile qumis_prod]
sso_session = qumis_sso
sso_account_id = 729033428609
sso_role_name = AdministratorAccess
region = us-east-2
output = json

# Shared Services
# --------------------------------
# Account: 355867115367
# Region: us-east-2
# Use: Shared infrastructure and services
[profile qumis_sharedservices]
sso_session = qumis_sso
sso_account_id = 355867115367
sso_role_name = AdministratorAccess
region = us-east-2
output = json
```

> **Info:** **Note**: The region is set to `us-east-2` for all profiles. Adjust the `sso_role_name` if you have a different role assigned.

### Test Access

```bash qumis-cli (Recommended)
# Login to an environment
qumis aws login dev

# Verify access
qumis lambda list-functions --env dev
```

```bash AWS CLI Direct
# Login directly via AWS CLI
aws sso login --profile qumis_dev

# Verify access
aws s3 ls --profile qumis_dev

# Check your identity
aws sts get-caller-identity --profile qumis_dev
```

> **Tip:** Use `qumis aws login` for a streamlined experience. It handles profile selection and SSO automatically.

## Ruby Development Setup

For API development:

```bash
# Install Ruby version manager
brew install rbenv ruby-build

# Install required Ruby version
rbenv install 3.2.2  # Check .ruby-version in qumis-api
rbenv global 3.2.2

# Install bundler
gem install bundler

# Install Rails dependencies
cd qumis-api
bundle install
```

## Node.js Development Setup

For web development:

```bash
# Using nvm (recommended)
nvm install 20
nvm use 20

# Install dependencies
cd qumis-web
npm install

# Install useful global packages
npm install -g typescript tsx prettier eslint
```

## Editor Configuration

### VS Code Extensions

Recommended extensions for Qumis development:

```bash
# Install via command palette or terminal
code --install-extension dbaeumer.vscode-eslint
code --install-extension esbenp.prettier-vscode
code --install-extension rebornix.ruby
code --install-extension castwide.solargraph
code --install-extension golang.go
code --install-extension hashicorp.terraform
code --install-extension amazonwebservices.aws-toolkit-vscode
```

### Git Configuration

```bash
# Set up your identity
git config --global user.name "Your Name"
git config --global user.email "your.email@qumis.ai"

# Useful aliases
git config --global alias.st status
git config --global alias.co checkout
git config --global alias.br branch
git config --global alias.cm commit
git config --global alias.pl pull
git config --global alias.ps push
```

## Shell Enhancements

### qumis-cli Aliases

If you installed with shell integration, you get these aliases:

```bash
q status      # Same as: qumis status
q sync        # Same as: qumis sync
q pr view     # Same as: qumis pr view
```

### Useful Shell Aliases

Add to your `~/.zshrc` or `~/.bashrc`:

```bash
# Navigation shortcuts
alias qa='qumis aws login qa'
alias dev='qumis aws login dev'
alias prod='qumis aws login prod'

# Common operations
alias gst='git status'
alias gco='git checkout'
alias gup='git up'  # Requires pygitup

# Rails shortcuts
alias rc='qumis services exec api --env dev -- rails console'
alias rdbm='qumis services exec api --env dev -- rails db:migrate'
```

## Verification Checklist

After setup, verify everything works:

- \[ ] `qumis --version` shows the current version
- \[ ] `qumis doctor` shows all green checkmarks
- \[ ] `qumis aws login dev` successfully authenticates
- \[ ] `git clone https://github.com/qumisinc/qumis-api.git` works
- \[ ] `aws s3 ls --profile qumis_dev` lists S3 buckets
- \[ ] `gh auth status` shows you're logged in to GitHub

## Troubleshooting

### Common Issues

### qumis: command not found

Add Go bin directory to your PATH:

```bash
echo 'export PATH=$PATH:$(go env GOPATH)/bin' >> ~/.zshrc
source ~/.zshrc
```

### AWS SSO token expired

Refresh your SSO session:

```bash
aws sso login --profile qumis_dev
# OR
qumis aws login dev
```

### GitHub authentication failed

Re-authenticate with GitHub:

```bash
gh auth login
# Choose GitHub.com, HTTPS, and authenticate via browser
```

### Permission denied for qumis repositories

Ensure you have been added to the Qumis GitHub organization. Contact your team lead if you're getting 404 errors on private repositories.

## Next Steps

Once your tools are set up:

1. Review the [Git Branching Strategies](/internal/engineering/guides/git-branching-strategies)
2. Learn about [Production Deployment](/internal/engineering/deployment/production-deployment)
3. Explore [qumis-cli commands](/internal/engineering/operations/qumis-cli-reference)

---

# Engineering Guides

Source: internal/engineering/guides/index

Practical guides and video walkthroughs covering the engineering workflows you use every day.

Keep your feature branches in sync with the release branch, resolve merge conflicts, and follow our team Git workflow

---

# Git Branching Strategies

Source: internal/engineering/guides/git-branching-strategies

## Video Walkthrough

A walkthrough of how to keep your feature branches in sync with the release branch and resolve merge conflicts when they arise.

### Quick Reference - Update Your Branch

### Choose your update strategy:

```bash Rebase (Recommended)
git checkout release
git pull origin release
git checkout your-feature-branch
git rebase release
git push --force-with-lease
```

```bash Merge (Safer)
git checkout release
git pull origin release
git checkout your-feature-branch
git merge release
git push
```

> **Info:** **Rebase** creates a clean linear history. **Merge** preserves the exact timeline without requiring force push.

> **Warning:** If you see conflicts, you'll need to resolve them. See the [Troubleshooting](#troubleshooting) section.

## The Core Problem

Since we are growing our engineering team and we will all merging PRs to the same branch asynchronously, we will regularly be out of sync.

**If another engineer merged their PR to `release` while you were working, your feature branch will be behind `origin/release`**

When your feature branch falls behind the remote release branch, creating a PR without updating causes:

- Other people's commits appearing in your PR
- Confused code reviewers
- Hidden feature scope
- Difficult merge conflicts
- Misleading git blame history

If you are out of sync, you will not reliably be able to ensure merging your feature branch will not introduce issues.

### What This Looks Like

**Out of Sync:**

```mermaid
---
config:
  logLevel: 'debug'
  theme: 'default'
  themeVariables:
      'git1': '#F0BF00'
---
gitGraph
    commit id: "A"
    commit id: "B"
    branch your-feature
    checkout your-feature
    commit id: "X (your work)"
    commit id: "Y (your work)"
    checkout main
    commit id: "C (colleague's work)"
    commit id: "D (colleague's work)"
    checkout your-feature
    commit id: "Z (your work)"
```

### What It Should Look Like

**In Sync:**

```mermaid
---
config:
  logLevel: 'debug'
  theme: 'default'
  themeVariables:
      'git1': '#00ff00'
---
gitGraph
    commit id: "A"
    commit id: "B"
    commit id: "C (colleague's)"
    commit id: "D (colleague's)"
    branch your-feature
    checkout your-feature
    commit id: "X' (your work)"
    commit id: "Y' (your work)"
    commit id: "Z' (your work)"
```

## Step-by-Step: Rebase (Recommended)

> **Tip:** Claude Code makes rebase or merge conflicts much easier! [See the Claude Code](#claude-code-can-help-with-conflicts) section.

âœ… **Use this for**: Regular feature branches, bug fixes, most daily work

### Update your local release branch

```bash
git checkout release
git pull origin release
```

### Switch to your feature branch

```bash
git checkout your-feature-branch  # e.g., erik/eng-984-add-auth
```

### Rebase onto the updated release

```bash
git rebase release
```

### Force push safely

```bash
git push --force-with-lease
```

> **Warning:** Never use `--force` alone. Always use `--force-with-lease` for safety.

### If You Hit Conflicts

### Fix the conflicted files

Your editor will show `<<<<` markers indicating conflicts. Review and resolve each conflict.

### Stage the fixed files

```bash
git add .
```

### Continue rebasing

```bash
git rebase --continue
```

### Repeat if more conflicts appear

If additional conflicts occur, repeat steps 1-3 until the rebase completes.

> **Tip:** **Escape hatch**: If things go wrong, run `git rebase --abort` to undo everything.

## Step-by-Step: Merge (Alternative)

âš ï¸ **Use this for**: Long-running features, when rebase is too complex, or if you're not comfortable with force pushing

### Update your local release branch

```bash
git checkout release
git pull origin release
```

### Switch to your feature branch

```bash
git checkout your-feature-branch
```

### Merge release into your branch

```bash
git merge release
```

### Push normally

```bash
git push origin your-feature-branch
```

## Our Branching Model

```
main (production)
â””â”€ release (staging)
   â”œâ”€ erik/eng-983-feature-one
   â”œâ”€ sarah/eng-984-feature-two
   â””â”€ alex/eng-985-feature-three
```

- **Branch naming**: `engineer-name/ticket-id-description`
- **Base branch**: Always branch from `release`
- **Target branch**: Always merge back to `release`

## The Two Solutions

### Quick Comparison

| | Rebase (Recommended) | Merge (Alternative) |
|---|---|---|
| **Result** | Clean, linear history | Preserves exact timeline |
| **Safety** | Requires `--force-with-lease` | Normal push |
| **Best For** | Most feature work | Long-running branches |
| **Complexity** | Moderate | Simple |

> **Info:** **Our Recommendation**: Use **rebase** for feature branches. It keeps our Git history clean and makes code reviews easier. Only use merge if you're uncomfortable with rebase or working on a long-running feature.

### Claude Code Can Help With Conflicts

If you encounter merge conflicts during a rebase, Claude Code can help you resolve them:

```bash
# When you hit conflicts during rebase, ask Claude:
claude "I'm currently in the middle of a rebase that has merge conflicts. Can you help me resolve them and finish the rebase?"
```

Claude Code will analyze the conflicts, help you resolve them, and complete the rebase process.

### Making Rebasing Easier - Recommended Git Config

These git configurations will make rebasing smoother and more automated:

```bash
# Remember how you resolved conflicts and reuse those resolutions
git config --global rerere.enabled true
git config --global rerere.autoUpdate true

# Automatically stash and unstash changes during rebase
git config --global rebase.autoStash true
```

> **Tip:** **What these settings do:**
>
> - `rerere` (REuse REcorded REsolution) remembers how you resolved conflicts and applies them automatically next time
> - `autosquash` automatically reorders commits marked with `fixup!` or `squash!`
> - `autoStash` stashes any uncommitted changes before rebasing and applies them after

## Troubleshooting

### Common Problems & Solutions

### I see merge conflicts

```bash
# For rebase conflicts:
# 1. Fix conflicts in your editor (look for <<<< markers)
git add .
git rebase --continue

# Too many conflicts? Abort and try merge instead:
git rebase --abort
git merge release  # Try merge strategy instead
```

### I accidentally pushed to the wrong branch

```bash
# Undo the last commit (keep changes)
git reset --soft HEAD~1
# Switch to correct branch
git checkout -b correct-branch-name
# Commit and push to right place
git commit -m "your message"
git push origin correct-branch-name
```

### My PR still shows other people's commits

You forgot to update your branch. Follow the [Quick Fix](#emergency-need-to-fix-your-branch-right-now) at the top of this guide.

### Git says 'cannot push' after rebase

You need to force push after rebasing:

```bash
git push --force-with-lease
```

### I want to start over completely

```bash
# Save your work first!
git stash
# Reset to match remote release
git fetch origin
git reset --hard origin/release
# Apply your changes back
git stash pop
```

## Best Practices

### âœ… DO

- Update your branch **before** creating a PR
- Use `--force-with-lease` (never just `--force`)
- Pull from `release` at least once daily
- Ask for help if confused (#engineering channel)
- Test your code after updating

### ðŸ›‘ DON'T

- Create PRs without updating first
- Force push to `main` or `release`
- Rebase commits others are using
- Mix rebase and merge randomly
- Panic

## Command Reference

### Essential Commands

```bash
# Update your branch (Rebase)
git checkout release && git pull
git checkout your-branch
git rebase release
git push --force-with-lease

# Update your branch (Merge)
git checkout release && git pull
git checkout your-branch
git merge release
git push

# Emergency exits
git rebase --abort      # Cancel a rebase
git merge --abort       # Cancel a merge
git reset --hard HEAD~1 # Undo last commit (destructive!)
```

### Getting Help

- **Slack**: `#engineering` channel
- **Pair Programming**: Ask a teammate to screen-share
- **Documentation**: This guide and [Git official docs](https://git-scm.com/docs)

---

# Production Deployment Cheatsheet

Source: internal/engineering/deployment/deployment-cheatsheet

Quick reference guide for production operations. All commands are copy-paste ready.

> **Info:** **For detailed procedures and explanations**, refer to the full deployment guides:
>
> - [Production Deployment](/internal/engineering/deployment/production-deployment)
> - [Post-Deployment Validation](/internal/engineering/deployment/post-deployment-validation)
> - [qumis-cli Reference](/internal/engineering/operations/qumis-cli-reference)

## Environment Reference

| Item | Value |
|------|-------|
| **AWS Profile** | `qumis_prod` |
| **Region** | us-east-2 |
| **Services** | api, web, sidekiq |

**AWS Console:** [https://qumis.awsapps.com/start/#/?tab=accounts](https://qumis.awsapps.com/start/#/?tab=accounts)

> **Tip:** **Visual Guide**: See [AWS Environments â†’ AWS Console Access](/internal/engineering/infrastructure/aws-environments#aws-console-access) for a screenshot showing how to select the production environment from the SSO portal.

### Additional Environment Details

**Account ID:** 729033428609

**URLs:**

- API: https://api.qumis.ai
- Web: https://app.qumis.ai

**Log Groups:**
| Service | Log Group |
|---------|-----------|
| API | `ecs/blue/prod/api` |
| Web | `ecs/blue/prod/web` |
| Sidekiq | `ecs/blue/prod/sidekiq` |

## Rails Console

> **Warning:** Production console access requires `--confirm "prod"` and a descriptive `--reason` for audit logging.

```bash
qumis services exec api \
  --env prod \
  --reason "Debug customer issue #123" \
  --confirm "prod" \
  -- rails console
```

## Check Production Status

```bash
# Service info
qumis services info api --env prod
qumis services info web --env prod

# Health endpoints
curl https://api.qumis.ai/health
curl https://app.qumis.ai/health

# AWS login (if needed)
qumis aws login prod
```

## Environment Variables & Secrets

### List Configured Variables and Secrets

```bash
# API service
qumis vars list api --env prod
qumis secrets list api --env prod

# Web service
qumis vars list web --env prod
qumis secrets list web --env prod
```

### Inspect Running Environment Variables

```bash
# API service
qumis services exec api \
  --env prod \
  --reason "Print ENV vars" \
  --confirm "prod" \
  -- env | grep -E "^[A-Z_]+=.*" | sort

# Web service
qumis services exec web \
  --env prod \
  --reason "Print ENV vars" \
  --confirm "prod" \
  -- env | grep -E "^[A-Z_]+=.*" | sort
```

## Deploy to Production

> **Warning:** Always verify UAT deployment before production. Requires `--confirm` flag and descriptive `--reason`.

```bash
# API service
qumis deploy api \
  --env prod \
  --reason "Deploy v1.2.3 - ENG-123" \
  --workflow-ref "release" \
  --confirm

# Web service
qumis deploy web \
  --env prod \
  --reason "Deploy v1.2.3 - ENG-123" \
  --workflow-ref "release" \
  --confirm
```

## Monitor Deployments

### GitHub Actions

```bash
# List recent workflow runs
gh run list --repo qumis-hq/qumis --limit 5

# Watch specific run
gh run watch <run-id> --repo qumis-hq/qumis

# View run logs
gh run view <run-id> --repo qumis-hq/qumis --log
```

### CloudWatch Logs

```bash
# Tail logs in real-time
aws logs tail ecs/blue/prod/api \
  --profile qumis_prod \
  --follow

aws logs tail ecs/blue/prod/web \
  --profile qumis_prod \
  --follow

aws logs tail ecs/blue/prod/sidekiq \
  --profile qumis_prod \
  --follow

# Tail with filter
aws logs tail ecs/blue/prod/api \
  --profile qumis_prod \
  --follow \
  --filter-pattern "ERROR"
```

## Check for Errors

### Last 5 Minutes

```bash
# API errors
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/api \
  --start-time $(date -u -v-5M +%s)000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod

# Web errors
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/web \
  --start-time $(date -u -v-5M +%s)000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod

# Sidekiq errors
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/sidekiq \
  --start-time $(date -u -v-5M +%s)000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod
```

### Last Hour

```bash
# API errors (last hour)
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/api \
  --start-time $(date -u -v-1H +%s)000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod

# Web errors (last hour)
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/web \
  --start-time $(date -u -v-1H +%s)000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod
```

## Quick Diagnostics

### ECS Services

```bash
# API service status
aws ecs describe-services \
  --cluster qumis-prod \
  --services api-service \
  --profile qumis_prod

# Web service status
aws ecs describe-services \
  --cluster qumis-prod \
  --services web-service \
  --profile qumis_prod

# List all services
aws ecs list-services \
  --cluster qumis-prod \
  --profile qumis_prod
```

### Sidekiq Status

```bash
# Check Sidekiq queue status
qumis services exec api \
  --env prod \
  --reason "Check Sidekiq status" \
  --confirm "prod" \
  -- bundle exec rails runner "puts Sidekiq::Stats.new.inspect"

# Check queue sizes
qumis services exec api \
  --env prod \
  --reason "Check queue sizes" \
  --confirm "prod" \
  -- bundle exec rails runner "puts Sidekiq::Queue.all.map { |q| [q.name, q.size] }.to_h.inspect"
```

### Database Connectivity

```bash
# Check database connection
qumis services exec api \
  --env prod \
  --reason "Check DB connection" \
  --confirm "prod" \
  -- bundle exec rails runner "puts ActiveRecord::Base.connection.active?"

# Run a simple query
qumis services exec api \
  --env prod \
  --reason "Test DB query" \
  --confirm "prod" \
  -- bundle exec rails runner "puts User.count"
```

### Rails Commands

```bash
# View routes
qumis services exec api \
  --env prod \
  --reason "View routes" \
  --confirm "prod" \
  -- bundle exec rails routes

# Check Rails environment
qumis services exec api \
  --env prod \
  --reason "Check environment" \
  --confirm "prod" \
  -- bundle exec rails runner "puts Rails.env"

# Database migration status
qumis services exec api \
  --env prod \
  --reason "Check migrations" \
  --confirm "prod" \
  -- bundle exec rails db:migrate:status
```

## Common Operations

### Verify Deployment

```bash
# 1. Check service health
qumis services info api --env prod
qumis services info web --env prod

# 2. Verify health endpoints
curl https://api.qumis.ai/health
curl https://app.qumis.ai/health

# 3. Check for errors (last 5 min)
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/api \
  --start-time $(date -u -v-5M +%s)000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod

# 4. Test critical feature (example)
curl -X POST https://api.qumis.ai/api/v1/auth/verify \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Clear Cache (if applicable)

```bash
# Clear Rails cache
qumis services exec api \
  --env prod \
  --reason "Clear cache" \
  --confirm "prod" \
  -- bundle exec rails runner "Rails.cache.clear"
```

### Restart Services

```bash
# Restart API service (via deployment)
qumis deploy api \
  --env prod \
  --reason "Restart service" \
  --workflow-ref "release" \
  --confirm

# Force new deployment (same version)
qumis deploy api \
  --env prod \
  --reason "Force restart" \
  --workflow-ref "release" \
  --confirm
```

## Emergency Contacts

For production incidents:

1. Check [CloudWatch Alerts](/internal/engineering/infrastructure/cloudwatch-alerts)
2. Review [Common Issues](/internal/engineering/troubleshooting/common-issues)
3. Escalate to on-call engineer via PagerDuty

## Best Practices

> **Warning:**&#x20;
>
> - **Always verify UAT** before deploying to production
> - **Use descriptive reasons** for all production commands (audit trail)
> - **Monitor for 15 minutes** after deployment
> - **Have rollback plan ready** before deploying
> - **Communicate** with team before production changes

---

# Production Deployment

Source: internal/engineering/deployment/production-deployment

> **Warning:** **Production deployments require**:
>
> - Code review approval on your PR
> - Successful deployment to UAT
> - Team lead or senior engineer approval
> - Proper audit log reason

## Prerequisites

Before deploying to production:

1. **qumis-cli installed**: See [Tools Setup](/internal/engineering/tools-setup)
2. **AWS Production access**: Verify with `qumis aws login prod`
3. **GitHub access**: Ensure your PR is approved and merged
4. **Deployment window**: Check #deployments channel for scheduled windows

## Deployment Process

> **Note:** **Interactive Confirmation for Production**: When deploying to production, the qumis-cli will display deployment details and prompt you to manually confirm by typing:
>
> 1. The deploy branch name (e.g., "release")
> 2. The environment name ("prod")
>
> This two-step confirmation replaces the previous `--confirm` flag and helps prevent accidental production deployments.

### Step 1: Pre-Deployment Checks

### Verify UAT Deployment

Ensure your changes are deployed and tested in UAT:

```bash
# Check UAT deployment status
qumis services info api --env uat

# Verify your changes are in UAT
qumis services exec api --env uat --reason "Verify deployment" -- rails runner "puts 'Version check'"
```

### Check Production Status

Verify current production state:

```bash
# Check current production version
qumis services info api --env prod

# Check current Lambda functions
qumis lambda list-functions --env prod
```

### Review Deployment Checklist

Go through the [Deployment Checklist](/internal/engineering/deployment/deployment-checklist) to ensure all items are completed.

### Step 2: Deploy to Production

### API Service

Deploy the Rails API service:

```bash
qumis deploy api \
  --deploy-branch "release" \
  --env "prod" \
  --reason "Deploy feature XYZ - Ticket ENG-123" \
  --workflow-ref "release"
```

> **Info:** **Interactive Confirmation**: For production deployments, the CLI will prompt you to manually type:
>
> - The deploy branch name (e.g., "release")
> - The environment name ("prod")
>
> This replaces the previous `--confirm` flag for added safety.

### Web Service

Deploy the web application:

```bash
qumis deploy web \
  --deploy-branch "release" \
  --env "prod" \
  --reason "Deploy UI updates - Ticket ENG-124" \
  --workflow-ref "release"
```

### LLM Service

> **Warning:** **Note**: `qumis deploy llm` is not yet available. Use the serverless command below from the `llm-service` repository.

Deploy the LLM service from the `llm-service` repository:

```bash
npx serverless deploy \
  --config serverless-qumis.yml \
  --stage prod \
  --verbose \
  --org qumis \
  --region us-east-2 \
  --aws-profile qumis_prod
```

### Step 3: Monitor Deployment

### Watch GitHub Actions

Monitor the deployment workflow in GitHub Actions:

**Direct Links:**

- API Service: [github.com/qumisinc/qumis-api/actions](https://github.com/qumisinc/qumis-api/actions)
- Web Service: [github.com/qumisinc/qumis-web/actions](https://github.com/qumisinc/qumis-web/actions)

Look for the workflow triggered by your deployment command.

### Monitor CloudWatch Logs

Watch for errors during deployment:

```bash
# Tail Lambda logs
aws logs tail /aws/lambda/qumis-api-prod --profile qumis_prod --follow

# Check for errors
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '5 minutes ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod
```

### Verify Deployment

Confirm the deployment succeeded:

```bash
# Check service info
qumis services info api --env prod

# Run a health check
qumis services exec api \
  --env prod \
  --reason "Post-deployment health check" \
  -- rails runner "puts 'Health: OK'"
```

## Deployment Commands Reference

### Required Flags

| Flag | Description | Example |
|------|-------------|---------|
| `--deploy-branch` | Git branch to deploy | `"release"` or `"hotfix-123"` |
| `--env` | Target environment | `"prod"` |
| `--reason` | Audit log reason | `"Deploy feature XYZ"` |
| `--workflow-ref` | GitHub workflow branch | `"release"` |

### Environment Mapping

| Environment | AWS Account | Confirmation Required |
|------------|-------------|----------------------|
| dev | 080970846004 | No |
| qa | 340452546718 | No |
| uat | 499854674638 | No |
| **prod** | **729033428609** | **Yes** (type branch & env) |

## Post-Deployment Tasks

### Immediate Verification

1. **Check application health**:
   ```bash
   # API health check
   curl https://api.qumis.ai/health

   # Web application check
   curl https://app.qumis.ai
   ```

2. **Monitor error rates**:
   ```bash
   # Check CloudWatch metrics
   aws cloudwatch get-metric-statistics \
     --namespace AWS/Lambda \
     --metric-name Errors \
     --dimensions Name=FunctionName,Value=qumis-api-prod \
     --start-time $(date -u -d '10 minutes ago' --iso-8601) \
     --end-time $(date -u --iso-8601) \
     --period 300 \
     --statistics Sum \
     --profile qumis_prod
   ```

3. **Verify key functionality**:
   - Test login flow
   - Check critical API endpoints
   - Verify database connectivity

### Communication

### Update Deployment Channel

Post in #deployments:

```
âœ… Production deployment complete
Service: API
Version: [commit SHA]
Reason: Deploy feature XYZ - ENG-123
Status: Healthy
```

### Update Linear Ticket

Mark the ticket as deployed:

```bash
# If using linear-cli
linear issue update ENG-123 --status "Deployed"
```

## Rollback Procedures

If issues are detected after deployment:

> **Warning:** **Act quickly but calmly**. Follow the [Rollback Procedures](/internal/engineering/deployment/rollback-procedures) guide.

Quick rollback command:

```bash
# Deploy the previous version
qumis deploy api \
  --deploy-branch "release" \
  --env "prod" \
  --reason "ROLLBACK: Issues detected with ENG-123" \
  --workflow-ref "release"
```

> **Note:** You'll be prompted to confirm by typing the branch name and environment.

## Security Considerations

### Audit Logging

All production deployments are logged with:

- Deployer's identity
- Timestamp
- Reason provided
- Git commit SHA
- Source and target branches

### Access Control

- Production deployments require explicit AWS production role
- GitHub branch protection prevents direct pushes to main
- Confirmation prompt prevents accidental deployments

### Sensitive Operations

When running Rails commands in production:

### Rails Console

```bash
qumis services exec api \
  --env prod \
  --reason "Debug customer issue #12345" \
  -- rails console
```

> **Warning:** Rails console in production has full database access. Be extremely careful with any data modifications.

### Database Migrations

```bash
qumis services exec api \
  --env prod \
  --reason "Run migration for feature ENG-123" \
  -- rails db:migrate
```

Always test migrations in UAT first!

## Troubleshooting

### Common Issues

### Deployment workflow not starting

Check:

- GitHub Actions is not experiencing an outage
- Your GitHub token has workflow permissions
- The workflow file exists on the specified `--workflow-ref` branch

### AWS permission denied

Ensure:

```bash
# Re-authenticate
qumis aws login prod

# Verify access
aws sts get-caller-identity --profile qumis_prod
```

### Deployment succeeded but app not working

1. Check Lambda function status
2. Review CloudWatch logs for startup errors
3. Verify environment variables are set correctly
4. Check database connectivity

## Best Practices

1. **Always deploy to UAT first** and wait for verification
2. **Deploy during low-traffic periods** when possible
3. **Monitor for 15-30 minutes** after deployment
4. **Keep deployments small** - easier to debug and rollback
5. **Document your deployment** in the audit log reason
6. **Communicate with the team** before and after deployment

## Related Documentation

Pre and post-deployment verification steps

Validate deployment success

Emergency rollback and recovery

Monitor logs and metrics

## Additional Resources

- [qumis-cli Reference](/internal/engineering/operations/qumis-cli-reference)
- [AWS Environments](/internal/engineering/infrastructure/aws-environments)
- [Troubleshooting Guide](/internal/engineering/troubleshooting/common-issues)

---

# Deployment Checklist

Source: internal/engineering/deployment/deployment-checklist

Use this checklist before and after every deployment to ensure safe and successful releases.

## Pre-Deployment Checklist

### Code Review & Testing

- \[ ] **Pull request approved** by at least one team member
- \[ ] **All CI checks passing** (tests, linting, security scans)
- \[ ] **No merge conflicts** with target branch
- \[ ] **Unit tests** cover new functionality
- \[ ] **Integration tests** verify API contracts
- \[ ] **Manual testing** completed in development environment

### Environment Progression

- \[ ] **Deployed to dev** and verified working
- \[ ] **Deployed to QA** and passed QA testing
- \[ ] **Deployed to UAT** and stakeholder approved
- \[ ] **Release notes** documented with changes

### Database & Infrastructure

- \[ ] **Database migrations** tested in UAT
- \[ ] **No breaking schema changes** without coordination
- \[ ] **Environment variables** documented if added/changed
- \[ ] **API version compatibility** maintained
- \[ ] **Infrastructure changes** applied via Infrastructure as Code

### Communication

- \[ ] **Deployment window** scheduled and communicated
- \[ ] **Team notified** in #deployments channel
- \[ ] **On-call engineer** aware of deployment
- \[ ] **Rollback plan** documented and ready

## Deployment Execution

### Pre-Flight Checks

```bash
# 1. Verify you're deploying the right commit
git log --oneline -5

# 2. Check current production version
qumis services info api --env prod

# 3. Verify UAT has your changes
qumis services info api --env uat

# 4. Check system health
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Errors \
  --dimensions Name=FunctionName,Value=qumis-api-prod \
  --start-time $(date -u -d '1 hour ago' --iso-8601) \
  --end-time $(date -u --iso-8601) \
  --period 3600 \
  --statistics Sum \
  --profile qumis_prod
```

### Deployment Commands

### Standard Deployment

```bash
# Deploy API to production
qumis deploy api \
  --deploy-branch "main" \
  --env "prod" \
  --reason "Deploy feature ABC - ENG-123" \
  --workflow-ref "main" \
  --confirm "prod"
```

### Hotfix Deployment

```bash
# Deploy hotfix branch
qumis deploy api \
  --deploy-branch "hotfix-critical-bug" \
  --env "prod" \
  --reason "HOTFIX: Critical bug fix - INC-456" \
  --workflow-ref "main" \
  --confirm "prod"
```

### During Deployment

- \[ ] **Monitor GitHub Actions** workflow progress
  - API: [github.com/qumisinc/qumis-api/actions](https://github.com/qumisinc/qumis-api/actions)
  - Web: [github.com/qumisinc/qumis-web/actions](https://github.com/qumisinc/qumis-web/actions)
- \[ ] **Watch CloudWatch logs** for errors
- \[ ] **Check deployment status** in AWS Console
- \[ ] **Alert team** if deployment is taking longer than expected

## Post-Deployment Checklist

### Immediate Verification (0-5 minutes)

- \[ ] **Deployment workflow** completed successfully
- \[ ] **Application started** without errors
- \[ ] **Health endpoints** responding
- \[ ] **No spike in error rates**

```bash
# Quick health check
curl -f https://api.qumis.ai/health || echo "Health check failed!"

# Check recent errors
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '5 minutes ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod
```

### Functional Verification (5-15 minutes)

- \[ ] **Login flow** working
- \[ ] **Core features** tested and working
- \[ ] **Database queries** performing normally
- \[ ] **External integrations** functioning
- \[ ] **Background jobs** processing

> **Info:** For comprehensive end-to-end validation, see the [Post-Deployment Validation Guide](/internal/engineering/deployment/post-deployment-validation)

### Performance Verification (15-30 minutes)

- \[ ] **Response times** within normal range
- \[ ] **Memory usage** stable
- \[ ] **CPU usage** normal
- \[ ] **Database connections** not exhausted
- \[ ] **No memory leaks** detected

```bash
# Check Lambda metrics
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Duration \
  --dimensions Name=FunctionName,Value=qumis-api-prod \
  --start-time $(date -u -d '30 minutes ago' --iso-8601) \
  --end-time $(date -u --iso-8601) \
  --period 300 \
  --statistics Average,Maximum \
  --profile qumis_prod
```

### Communication & Documentation

- \[ ] **Update #deployments** channel with status
- \[ ] **Update Linear ticket** to "Deployed" status
- \[ ] **Document any issues** encountered
- \[ ] **Update runbook** if new procedures discovered

## Environment-Specific Checklists

### Development Deployment

Simplified checklist for dev environment:

- \[ ] Code builds successfully
- \[ ] Basic smoke tests pass
- \[ ] Team notified of changes

### UAT Deployment

Additional checks for UAT:

- \[ ] Stakeholder notification sent
- \[ ] Test data prepared
- \[ ] Testing plan communicated
- \[ ] Rollback plan ready

### Production Deployment

Full checklist plus:

- \[ ] Change advisory board approval (if required)
- \[ ] Customer communication prepared (if user-facing)
- \[ ] Support team briefed
- \[ ] Monitoring alerts configured

## Rollback Criteria

Immediately rollback if any of these occur:

> **Warning:** **Critical Issues**:
>
> - Application fails to start
> - Database connection errors
> - Authentication system failure
> - Data corruption detected
> - Error rate > 10% of requests

Consider rollback for:

- Performance degradation > 50%
- Key features not working
- Integration failures with critical services
- Excessive memory or CPU usage

## Special Considerations

### Database Migrations

When deploying database migrations:

- \[ ] **Backup taken** before migration
- \[ ] **Migration reversible** or safe to leave
- \[ ] **Tested on production data copy**
- \[ ] **Downtime communicated** if required
- \[ ] **Verification queries** prepared

```bash
# Run migration with careful monitoring
qumis services exec api \
  --env prod \
  --reason "Run migration for ENG-123" \
  --confirm "prod" \
  -- rails db:migrate:status

# Verify migration succeeded
qumis services exec api \
  --env prod \
  --reason "Verify migration" \
  --confirm "prod" \
  -- rails runner "puts ActiveRecord::Base.connection.tables"
```

### Breaking Changes

For deployments with breaking changes:

- \[ ] **API version** incremented
- \[ ] **Deprecation notices** sent to consumers
- \[ ] **Migration guide** published
- \[ ] **Backwards compatibility** maintained (if possible)
- \[ ] **Coordinated deployment** with dependent services

### High-Risk Deployments

For significant changes or high-risk deployments:

- \[ ] **Canary deployment** considered
- \[ ] **Feature flags** in place
- \[ ] **Extended monitoring** period planned
- \[ ] **Rollback rehearsed** in UAT
- \[ ] **War room** scheduled with key stakeholders

## Automation Scripts

```bash pre-deploy-check.sh
#!/bin/bash
# pre-deploy-check.sh

echo "Running pre-deployment checks..."

# Check UAT deployment
echo "UAT Status:"
qumis services info api --env uat

# Check production health
echo "Production Health:"
curl -s https://api.qumis.ai/health | jq .

# Check error rates
echo "Recent errors:"
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '1 hour ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod \
  --max-items 10

echo "Pre-deployment checks complete"
```

```bash post-deploy-validate.sh
#!/bin/bash
# post-deploy-validate.sh

echo "Running post-deployment validation..."

# Health check
if curl -f -s https://api.qumis.ai/health > /dev/null; then
  echo "âœ… Health check passed"
else
  echo "âŒ Health check failed!"
  exit 1
fi

# Check for errors
ERROR_COUNT=$(aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '5 minutes ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod \
  --query 'events | length(@)')

if [ "$ERROR_COUNT" -gt 10 ]; then
  echo "âš ï¸ High error count detected: $ERROR_COUNT"
else
  echo "âœ… Error count normal: $ERROR_COUNT"
fi

echo "Post-deployment validation complete"
```

## Next Steps

- Execute [Post-Deployment Validation](/internal/engineering/deployment/post-deployment-validation) for comprehensive smoke testing
- Review [Rollback Procedures](/internal/engineering/deployment/rollback-procedures) to be prepared
- Set up [CloudWatch Alerts](/internal/engineering/infrastructure/cloudwatch-alerts) for automated monitoring
- Read [Production Deployment Guide](/internal/engineering/deployment/production-deployment) for detailed instructions

---

# Post-Deployment Validation

Source: internal/engineering/deployment/post-deployment-validation

This comprehensive smoke test checklist ensures all critical application functions work correctly after a production deployment. Execute these tests systematically to validate the release.

> **Info:** **Time Required**: 30-45 minutes for full validation
> **Prerequisites**: Test user account with Stytch SSO, sample PDFs (policy, binder, contract), access to monitoring tools

## Preconditions

Before starting validation, ensure you have:

- \[ ] **Test user account** with Stytch SSO and organization access
- \[ ] **Sample documents** ready:
  - Small PDF policy document
  - Binder or quote PDF
  - Contract PDF
- \[ ] **API endpoints** deployed and reachable
- \[ ] **LLM services** operational
- \[ ] **Monitoring access** to CloudWatch, Sentry, and FullStory

## 1. Login, Home & Navigation

### Initial Access

- \[ ] **Home page loads** (https://app.qumis.ai/) â†’ 200 OK
- \[ ] **No console errors** (check browser developer tools)
- \[ ] **All tiles visible**:
  - Chat with Documents
  - Compare Documents
  - Claims
  - Create Coverage Table
  - Policy Analysis
  - Documents Vault
  - Contracts
  - Custom Reporting
  - Legal Search

### Authentication

- \[ ] **Stytch SSO login** successful
- \[ ] **Session persistence** - refresh page, session maintained
- \[ ] **Logout** redirects to login page correctly

### Deep Links

Verify all routes load without 404 errors:

- \[ ] `/single-policy-analysis`
- \[ ] `/policy-comparison`
- \[ ] `/claim-coverage` (Coverage report)
- \[ ] `/coverage-checklist`
- \[ ] `/documents` (Vault)
- \[ ] `/chat`

## 2. Upload & Vault Operations

### My Vault

- \[ ] **Upload policy PDF** to My Vault
- \[ ] **Document appears** in vault list
- \[ ] **Viewer opens** document correctly
- \[ ] **Download** works properly

### Shared Vault

- \[ ] **Switch to Shared Vault** tab
- \[ ] **Upload binder PDF**
- \[ ] **Document visible** to team members
- \[ ] **Viewer functionality** works

### Vault Management

- \[ ] **Rename document** (if supported)
- \[ ] **Tag document** (if supported)
- \[ ] **Changes persist** after refresh
- \[ ] **Delete/restore** functions correctly

## 3. Search Functionality

### Uploaded Document Search (Typesense)

Test from the **Home search bar**:

- \[ ] **Search keyword** from uploaded policy
- \[ ] **Results include** the document
- \[ ] **Filters work** (if available)
- \[ ] **Pagination** functions correctly
- \[ ] **Result opens** correct document

### Vault Document Search

Test from **/documents** page:

- \[ ] **Search by filename** returns correct results
- \[ ] **Search by metadata** works
- \[ ] **Results open** in vault viewer
- \[ ] **Non-indexed documents** are findable

## 4. Single Policy Analysis

Navigate to `/single-policy-analysis`:

- \[ ] **Page loads** without errors
- \[ ] **Select policy PDF** from My Vault
- \[ ] **Generate button** clickable
- \[ ] **Progress indicator** shows during processing
- \[ ] **Job transitions** to Complete status
- \[ ] **Report opens** successfully

### Report Content

- \[ ] **Executive summary** renders
- \[ ] **Key findings** display correctly
- \[ ] **Limits table** present
- \[ ] **Endorsements** listed
- \[ ] **Interactive charts** function (if applicable)
- \[ ] **Download/Share** options work
- \[ ] **Report appears** in Home â†’ Recent

## 5. Policy Comparison

Navigate to `/policy-comparison`:

- \[ ] **Page loads** correctly
- \[ ] **Select two documents** (policy + binder)
- \[ ] **Run comparison** starts processing
- \[ ] **Status updates** to Complete
- \[ ] **Results display**:
  - Side-by-side tables
  - Difference callouts
  - Highlights render correctly
- \[ ] **Export/Download** functions work

## 6. Coverage Report

Navigate to `/claim-coverage`:

- \[ ] **Page loads** without errors
- \[ ] **Select policy** and claim context
- \[ ] **Generate report** processes successfully
- \[ ] **Findings render** correctly
- \[ ] **Recommendations** display
- \[ ] **Save/Export** options work

## 7. Coverage Checklist

Navigate to `/coverage-checklist`:

- \[ ] **Page loads** correctly
- \[ ] **Select policies** (one or more)
- \[ ] **Generate checklist**
- \[ ] **Table builds** with expected columns:
  - Limits
  - Deductibles
  - Carriers
- \[ ] **Excel/CSV download** works

## 8. Custom Reporting

From Home tile:

- \[ ] **Custom Reporting** opens
- \[ ] **Template selection** works
- \[ ] **Include uploaded document** in report
- \[ ] **Generation starts** and shows progress
- \[ ] **Status transitions** to Complete
- \[ ] **Final report** opens with:
  - Expected sections
  - Artifacts present
  - Proper formatting

## 9. Chat Functionality

### Global Chat (`/chat`)

- \[ ] **Chat page** opens correctly
- \[ ] **Ask question** referencing uploaded doc: "What is the general aggregate in policy.pdf?"
- \[ ] **Response uses** document context
- \[ ] **Citations/links** work (if featured)
- \[ ] **Save chat** function works
- \[ ] **Chat appears** in:
  - Chats list
  - Home â†’ Recent (Chats toggle)

### In-Report Chat

From any report page:

- \[ ] **Embedded chat** opens
- \[ ] **Ask question**: "Summarize key exclusions in this report"
- \[ ] **Response references** current report context
- \[ ] **Links jump** to relevant sections

## 10. Background Jobs & Reliability

### Queue Testing

- \[ ] **Queue 5 small jobs** (mix of uploads/reports)
- \[ ] **All process** within expected timeframe
- \[ ] **No stuck items** in queue/admin
- \[ ] **Retry mechanism** works for failed jobs

### Performance

- \[ ] **Response times** acceptable
- \[ ] **No timeout errors**
- \[ ] **Memory usage** normal
- \[ ] **CPU usage** within limits

## 11. Integrations & Observability

### Email Integration (Postmark)

- \[ ] **Send report via email**
- \[ ] **Postmark shows** Delivered status
- \[ ] **Email received** correctly

### Error Tracking (Sentry)

- \[ ] **Trigger handled error** (e.g., invalid filter)
- \[ ] **Event appears** in Sentry dashboard
- \[ ] **Context captured** correctly

### Session Recording (FullStory)

- \[ ] **Session recording** present for test user
- \[ ] **Events tracked** properly

### Monitoring

- \[ ] **CloudWatch metrics** show activity
- \[ ] **API logs** clean (no stack traces)
- \[ ] **LLM service logs** normal
- \[ ] **Slack alerts** functioning (if triggered)

## 12. Authentication & Permissions

### API Protection

- \[ ] **Unauthenticated request** â†’ 401 response
- \[ ] **Valid session request** â†’ 200 response

### Role-Based Access

- \[ ] **Role restrictions** enforced correctly
- \[ ] **Lower privilege user** blocked from restricted routes
- \[ ] **Admin functions** available to admin users only

### Session Management

- \[ ] **Logout** clears session
- \[ ] **Redirect to login** after logout
- \[ ] **Session timeout** works (if applicable)

## 13. Critical Failure Indicators

> **Warning:** **Immediate Rollback Required** if any of these occur:
>
> - Any health endpoint returns 5xx errors
> - Jobs enqueue but never complete
> - Model provider errors from LLM service
> - Search or storage services unavailable
> - Authentication consistently fails
> - Observability/alerts not functioning

## Execution Record

Track your validation progress:

| Step | Status | Tester | Timestamp | Notes |
|------|--------|--------|-----------|-------|
| **1. Login & Home** | â¬œ | | | |
| **2. Vault: My + Shared** | â¬œ | | | |
| **3. Search (Typesense)** | â¬œ | | | |
| **3. Search (Vault)** | â¬œ | | | |
| **4. Single Policy Analysis** | â¬œ | | | |
| **5. Policy Comparison** | â¬œ | | | |
| **6. Coverage Report** | â¬œ | | | |
| **7. Coverage Checklist** | â¬œ | | | |
| **8. Custom Report** | â¬œ | | | |
| **9. Chat (/chat)** | â¬œ | | | |
| **9. Chat (in report)** | â¬œ | | | |
| **10. Background Jobs** | â¬œ | | | |
| **11. Integrations** | â¬œ | | | |
| **12. Auth & Permissions** | â¬œ | | | |

## Validation Scripts

```bash quick-health-check.sh
#!/bin/bash
# quick-health-check.sh

echo "ðŸ” Running quick health checks..."

# Check main application
echo -n "App Health: "
if curl -f -s https://app.qumis.ai/health > /dev/null; then
  echo "âœ… OK"
else
  echo "âŒ FAILED"
fi

# Check API
echo -n "API Health: "
if curl -f -s https://api.qumis.ai/health > /dev/null; then
  echo "âœ… OK"
else
  echo "âŒ FAILED"
fi

# Check for recent errors
echo "Recent Errors:"
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '5 minutes ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --max-items 5 \
  --profile qumis_prod
```

```bash comprehensive-validation.sh
#!/bin/bash
# comprehensive-validation.sh

echo "ðŸ§ª Starting comprehensive validation..."

# Function to test endpoint
test_endpoint() {
  local url=$1
  local name=$2

  if curl -f -s "$url" > /dev/null; then
    echo "âœ… $name: OK"
    return 0
  else
    echo "âŒ $name: FAILED"
    return 1
  fi
}

# Test all critical endpoints
test_endpoint "https://app.qumis.ai/" "Home Page"
test_endpoint "https://app.qumis.ai/documents" "Documents Vault"
test_endpoint "https://app.qumis.ai/chat" "Chat Interface"
test_endpoint "https://api.qumis.ai/health" "API Health"

# Check background jobs
echo "Checking Sidekiq..."
qumis services exec api \
  --env prod \
  --reason "Check Sidekiq status" \
  --confirm "prod" \
  -- rails runner "puts Sidekiq::Stats.new.to_h"

echo "Validation complete!"
```

## Troubleshooting Common Issues

### Login Issues

- **Check** Stytch service status
- **Verify** SSO configuration
- **Review** CloudWatch logs for auth errors

### Document Processing Failures

- **Verify** S3 bucket accessibility
- **Check** Lambda function logs
- **Confirm** PDF processing service is running

### Search Not Working

- **Check** Typesense service health
- **Verify** indexing jobs are running
- **Review** search service logs

### Report Generation Stuck

- **Check** Sidekiq queue depth
- **Verify** LLM service availability
- **Review** background job logs
- **Check** for rate limiting

## Next Steps

After successful validation:

1. **Update deployment tracker** with completion status
2. **Notify team** in #deployments channel
3. **Monitor metrics** for 30 minutes post-deployment
4. **Document any issues** encountered

For issues or rollback:

- See [Rollback Procedures](/internal/engineering/deployment/rollback-procedures)
- Check [Common Issues](/internal/engineering/troubleshooting/common-issues)
- Review [CloudWatch Monitoring](/internal/engineering/infrastructure/cloudwatch-monitoring)

---

# Rollback Procedures

Source: internal/engineering/deployment/rollback-procedures

> **Warning:** **In case of production incident**: Stay calm, follow these procedures systematically, and communicate with the team throughout the process.

## Quick Rollback

If you need to rollback immediately:

```bash
# 1. Get the previous working commit
git log --oneline -10

# 2. Deploy the previous version
qumis deploy api \
  --deploy-branch "main" \
  --env "prod" \
  --reason "ROLLBACK: [Brief description of issue]" \
  --workflow-ref "main" \
  --confirm "prod"
```

## Rollback Decision Tree

```mermaid
graph TD
    A[Issue Detected] --> B{Is app running?}
    B -->|No| C[Immediate Rollback]
    B -->|Yes| D{Error rate?}
    D -->|>10%| C
    D -->|<10%| E{Critical feature broken?}
    E -->|Yes| C
    E -->|No| F{Performance degraded?}
    F -->|>50%| G[Consider Rollback]
    F -->|<50%| H[Monitor & Fix Forward]
    C --> I[Execute Rollback]
    G --> J{Can fix quickly?}
    J -->|No| I
    J -->|Yes| H
```

## Step-by-Step Rollback Process

### Step 1: Assess the Situation

### Identify the Issue

Gather information quickly:

```bash
# Check application health
curl -f https://api.qumis.ai/health

# View recent errors
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '10 minutes ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod \
  --max-items 20

# Check Lambda function status
aws lambda get-function \
  --function-name qumis-api-prod \
  --profile qumis_prod \
  --query 'Configuration.State'
```

### Determine Severity

Classify the issue:

**Critical** (Rollback immediately):

- Application not starting
- Authentication broken
- Data corruption
- > 10% error rate

**High** (Rollback likely):

- Core features broken
- Significant performance degradation
- Database connection issues

**Medium** (Evaluate options):

- Non-critical features affected
- Minor performance impact
- Workaround available

### Communicate Status

Notify the team immediately:

```
ðŸš¨ INCIDENT: Production Issue Detected
Service: API
Severity: Critical
Issue: [Brief description]
Action: Initiating rollback
```

Post in:

- \#incidents channel
- \#engineering channel
- Page on-call if critical

### Step 2: Execute Rollback

### Code Rollback

Deploy the last known good version:

```bash
# 1. Find the last working deployment
git log --oneline --grep="Deploy" -10

# 2. Identify the commit SHA
LAST_GOOD_COMMIT="abc123def"  # Replace with actual SHA

# 3. Create rollback branch (optional but recommended)
git checkout -b rollback/incident-$(date +%Y%m%d-%H%M%S) $LAST_GOOD_COMMIT

# 4. Deploy the rollback
qumis deploy api \
  --deploy-branch "rollback/incident-$(date +%Y%m%d-%H%M%S)" \
  --env "prod" \
  --reason "ROLLBACK: Critical issue - reverting to $LAST_GOOD_COMMIT" \
  --workflow-ref "main" \
  --confirm "prod"
```

### Database Rollback

For database migration issues:

```bash
# 1. Check migration status
qumis services exec api \
  --env prod \
  --reason "Check migration status for rollback" \
  --confirm "prod" \
  -- rails db:migrate:status

# 2. Rollback the migration
qumis services exec api \
  --env prod \
  --reason "ROLLBACK: Database migration causing issues" \
  --confirm "prod" \
  -- rails db:rollback STEP=1

# 3. Verify rollback succeeded
qumis services exec api \
  --env prod \
  --reason "Verify migration rollback" \
  --confirm "prod" \
  -- rails db:migrate:status
```

> **Warning:** Database rollbacks can cause data loss. Only rollback migrations that are safe to reverse.

### Configuration Rollback

For environment variable or configuration issues:

```bash
# 1. Revert environment variables in AWS Lambda console
# or via AWS CLI:

aws lambda update-function-configuration \
  --function-name qumis-api-prod \
  --environment Variables={KEY1=old_value,KEY2=old_value} \
  --profile qumis_prod

# 2. Wait for update to complete
aws lambda wait function-updated \
  --function-name qumis-api-prod \
  --profile qumis_prod

# 3. Restart the function (triggers new container)
aws lambda invoke \
  --function-name qumis-api-prod \
  --payload '{"warmup": true}' \
  --profile qumis_prod \
  /dev/null
```

### Step 3: Verify Rollback

### Monitor Deployment

Watch the rollback deployment:

**GitHub Actions:**

- API Service: [github.com/qumisinc/qumis-api/actions](https://github.com/qumisinc/qumis-api/actions)
- Web Service: [github.com/qumisinc/qumis-web/actions](https://github.com/qumisinc/qumis-web/actions)

```bash
# Watch CloudWatch logs
aws logs tail /aws/lambda/qumis-api-prod --profile qumis_prod --follow
```

### Validate Functionality

Verify the system is working:

```bash
# Health check
curl -f https://api.qumis.ai/health

# Test critical endpoints
curl -f https://api.qumis.ai/api/v1/status

# Check error rates
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '5 minutes ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod \
  --query 'events | length(@)'
```

### Update Status

Communicate rollback completion:

```
âœ… ROLLBACK COMPLETE
Service: API
Rolled back to: [commit SHA]
Current status: Healthy
Error rate: Normal
Next steps: RCA to follow
```

## Rollback Scenarios

### Scenario 1: Application Won't Start

**Symptoms**: Lambda function failing to initialize, timeout errors

**Actions**:

1. Immediate rollback to previous version
2. Check CloudWatch logs for initialization errors
3. Verify environment variables are correct
4. Check for missing dependencies

### Scenario 2: Database Connection Errors

**Symptoms**: Cannot connect to RDS, connection pool exhausted

**Actions**:

1. Check RDS status and connectivity
2. Verify security groups and network configuration
3. Check connection pool settings
4. Consider increasing Lambda concurrent executions

### Scenario 3: High Error Rate

**Symptoms**: >10% of requests failing, 500 errors

**Actions**:

1. Identify error patterns in logs
2. Check for null pointer exceptions or missing data
3. Verify external service dependencies
4. Rollback if cannot identify quick fix

### Scenario 4: Performance Degradation

**Symptoms**: Response times >3x normal, timeouts

**Actions**:

1. Check for N+1 queries or inefficient code
2. Verify database indices are present
3. Check for memory leaks
4. Monitor Lambda cold starts

## Fix Forward vs Rollback

### When to Fix Forward

Consider fixing forward when:

- Issue is isolated to non-critical feature
- Fix is simple and well-understood
- Risk of fix is lower than rollback
- Rollback would cause data inconsistency

### When to Rollback

Always rollback when:

- Application is completely down
- Core functionality is broken
- Data corruption is occurring
- Security vulnerability is exposed
- Fix is complex or uncertain

## Post-Rollback Actions

### Immediate (Within 1 hour)

1. **Stabilize the system**
   - Verify all services are healthy
   - Check for any lingering issues
   - Monitor error rates and performance

2. **Document the incident**
   - Create incident report
   - Capture logs and metrics
   - Document timeline of events

3. **Communicate with stakeholders**
   - Update customers if affected
   - Inform leadership of status
   - Schedule RCA meeting

### Short-term (Within 24 hours)

1. **Root Cause Analysis**
   - Identify what went wrong
   - Determine why it wasn't caught earlier
   - Document lessons learned

2. **Fix the issue**
   - Develop proper fix
   - Add tests to prevent recurrence
   - Test thoroughly in UAT

3. **Update procedures**
   - Update deployment checklist
   - Add monitoring for issue
   - Update runbooks

### Long-term (Within 1 week)

1. **Process improvements**
   - Review deployment process
   - Enhance testing coverage
   - Improve monitoring and alerting

2. **Share learnings**
   - Present RCA to team
   - Update documentation
   - Share with broader organization

## Emergency Contacts

### Escalation Path

1. **On-call Engineer**: Check PagerDuty
2. **Team Lead**: Check #engineering channel topic
3. **Infrastructure Team**: #infrastructure channel
4. **Security Team**: #security channel (if security-related)

### External Dependencies

- **AWS Support**: Available through AWS Console
- **GitHub Support**: https://support.github.com
- **Database Admin**: Check runbook for contact

## Rollback Automation

### Automated Rollback Script

Save this script for emergency use:

```bash
#!/bin/bash
# emergency-rollback.sh

set -e

echo "ðŸš¨ EMERGENCY ROLLBACK INITIATED"

# Get the last successful deployment
LAST_GOOD_SHA=$(git log --oneline --grep="Deploy to prod" -2 | tail -1 | cut -d' ' -f1)

if [ -z "$LAST_GOOD_SHA" ]; then
    echo "âŒ Could not find last good deployment"
    exit 1
fi

echo "Rolling back to: $LAST_GOOD_SHA"

# Create rollback branch
ROLLBACK_BRANCH="rollback/emergency-$(date +%Y%m%d-%H%M%S)"
git checkout -b $ROLLBACK_BRANCH $LAST_GOOD_SHA

# Deploy rollback
qumis deploy api \
  --deploy-branch "$ROLLBACK_BRANCH" \
  --env "prod" \
  --reason "EMERGENCY ROLLBACK to $LAST_GOOD_SHA" \
  --workflow-ref "main" \
  --confirm "prod"

echo "âœ… Rollback deployment initiated"
echo "Monitor at: https://github.com/qumisinc/qumis-api/actions"
```

## Additional Resources

- [Production Deployment Guide](/internal/engineering/deployment/production-deployment)
- [Deployment Checklist](/internal/engineering/deployment/deployment-checklist)
- [CloudWatch Monitoring](/internal/engineering/infrastructure/cloudwatch-monitoring)
- [Debugging Production](/internal/engineering/troubleshooting/debugging-production)

---

# Release Notes

Source: internal/engineering/release-notes/index

Internal release notes tracking production deployments for the Qumis platform. Each release documents features, bug fixes, breaking changes, and deployment details.

> **Tip:** **Latest Release:** [2026-02-04](/internal/engineering/release-notes/2026/2026-02-04) | **Template:** [Release Notes Template](/internal/engineering/release-notes/template)
>
> **Related:** [Deployment Cheatsheet](/internal/engineering/deployment/deployment-cheatsheet) | [Production Deployment](/internal/engineering/deployment/production-deployment) | [Rollback Procedures](/internal/engineering/deployment/rollback-procedures)

## Timeline

Onboarding v2 with guided walkthrough, real-time report progress tracking, legal citations option for Policy Fact Analysis, Chameleon analytics, OAuth-based docs authentication, and feature flag system. Plus 10 bug fixes and 6 improvements.

[View full release notes â†’](/internal/engineering/release-notes/2026/2026-02-04)

## Related Documentation

Quick reference commands

Verify deployment success

Emergency recovery steps

---

# Release Notes Template

Source: internal/engineering/release-notes/template

> **Note:** **Template:** Copy this file to `release-notes/YYYY/YYYY-MM-DD.mdx` and fill in the details.
>
> Delete any sections that don't apply. Remove this note when done.

---

> **Info:** **Deployment Date:** MONTH DAY, YEAR
>
> **Deployed By:** NAME\_OR\_TEAM
>
> **Previous Deployment:** DATE(S)\_WITH\_PER\_SERVICE\_INFO\_IF\_THEY\_DIFFER

API Web LLM Service

## What's New

- **FEATURE\_NAME** â€” one-line user-facing description
- **FEATURE\_NAME** â€” one-line user-facing description
- X bug fixes and X improvements

*Narrative paragraph summarizing the release for non-technical readers. Use **bold** to highlight key features and explain user value. Example: "Users get a **completely redesigned onboarding experience** that guides new sign-ups through their first report, **real-time progress tracking** so they can see exactly what's happening, and a **new legal citations option** for reports."*

Brief summary

Brief summary

Brief summary

**+X** / **-X** lines

---

## Features

### FEATURE\_NAME

Plain-language description of what users will see or experience. 1-2 sentences explaining the value.

- Benefit or change 1
- Benefit or change 2
- Benefit or change 3

**Linear:** [ENG-XXXX](https://linear.app/qumis/issue/ENG-XXXX)

### FEATURE\_NAME\_2

Plain-language description.

- Benefit or change

**Linear:** [ENG-XXXX](https://linear.app/qumis/issue/ENG-XXXX)

---

## Bug Fixes

### User-Facing Fixes (X)

| Issue | Description | Ticket |
|-------|-------------|--------|
| Issue name | Plain-language description | [ENG-XXXX](https://linear.app/qumis/issue/ENG-XXXX) |

### Backend Fixes (X)

| Issue | Description | Ticket |
|-------|-------------|--------|
| Issue name | Description | [ENG-XXXX](https://linear.app/qumis/issue/ENG-XXXX) |

---

## Improvements

- **Improvement name** â€” description ([ENG-XXXX](https://linear.app/qumis/issue/ENG-XXXX))

---

## Technical Details

### Services Deployed

| Service | Commit | Files | Lines Changed |
|---------|--------|-------|---------------|
| API | `COMMIT` | X | +X / -X |
| Web | `COMMIT` | X | +X / -X |
| LLM Service | `COMMIT` | X | +X / -X |

**Previous deployment:** DATE\_OF\_LAST\_DEPLOYMENT

### Pull Requests (X total)

**API (X PRs)**
| PR | Description |
|----|-------------|
| [#XXX](https://github.com/qumisinc/qumis-api/pull/XXX) | Title |

**Web (X PRs)**
| PR | Description |
|----|-------------|
| [#XXX](https://github.com/qumisinc/qumis-web/pull/XXX) | Title |

**LLM Service (X PRs)**
| PR | Description |
|----|-------------|
| [#XXX](https://github.com/qumisinc/qumis-llm-service/pull/XXX) | Title |

### Related Linear Tickets

**Major Features:**

- [ENG-XXXX](https://linear.app/qumis/issue/ENG-XXXX) â€” Description

**Bug Fixes:**

- [ENG-XXXX](https://linear.app/qumis/issue/ENG-XXXX) â€” Description

**Improvements:**

- [ENG-XXXX](https://linear.app/qumis/issue/ENG-XXXX) â€” Description

---

# Release 2026-02-04

Source: internal/engineering/release-notes/2026/2026-02-04

> **Info:** **Deployment Date:** February 4, 2026
>
> **Deployed By:** Engineering Team
>
> **Previous Deployment:** January 29, 2026 (API/Web), January 15, 2026 (LLM Service)

API Web LLM Service

## What's New

- **Report progress tracking** â€” real-time status updates during report generation
- **Legal citations option** â€” toggle legal references in Policy Fact Analysis reports
- **Docs authentication** â€” seamless OAuth access to docs.qumis.ai
- **Feature flag system** â€” controlled rollouts without redeployment
- **Improved checklist detection** â€” better nested list and hierarchy detection
- [10 bug fixes](#bug-fixes) and [6 improvements](#improvements)

This is a significant release spanning all three services. Users get **real-time workflow progress tracking** so they can see exactly what's happening during report generation, and a **new legal citations option** for Policy Fact Analysis reports. Behind the scenes, we've added **OAuth-based docs authentication** so users access documentation seamlessly, and a **feature flag system** for controlled rollouts.

Progress tracking, legal citations, docs auth, feature flags, and more

Lambda timeouts, scrolling, PDF viewer, seat management, and bundling issues

Help center links, configurable credits, logging, and error handling

**+54,581** / **-1,817** lines

---

## Features

### User-Facing (3)

### Report Progress Tracking

Users can now see exactly what's happening while their report generates â€” a live progress indicator shows each processing phase in real time instead of a generic loading spinner.

- **Live workflow steps** displayed during report generation with status indicators (in-progress, completed, failed)
- **Human-readable phase names** (e.g., "Analyzing documents", "Extracting data", "Generating insights") instead of internal step identifiers
- **Deduplication of consecutive steps** to keep the progress view clean
- **Completion and failure states** with clear visual feedback
- **New WorkflowStep model and API** â€” the LLM Service reports progress back to the API via `POST /v1/reports/:id/workflow_steps`, enabling real-time frontend updates via polling

**Linear:** [ENG-1517](https://linear.app/qumis/issue/ENG-1517), [ENG-1518](https://linear.app/qumis/issue/ENG-1518)

### Field Name Hierarchy in Checklists

Nested checklist fields now display their full parent hierarchy, making it easier to understand where a field sits in complex insurance documents.

- Nested fields show parent names with visual hierarchy indicators (e.g., "Location > Building > Address")
- Clearer visual structure for deeply nested insurance form data
- Improved column alignment and list instance grouping in checklist tables

**Linear:** [ENG-1518](https://linear.app/qumis/issue/ENG-1518)

### Legal Citations Option for Policy Fact Analysis

Users can now choose whether to include legal citations when generating a Policy Fact Analysis report â€” the default flow is faster without them, while the full flow adds detailed legal references.

- **Default flow (no legal citations)** skips the legal research steps for faster report generation
- **Optional flow with legal citations** adds detailed legal references for comprehensive analysis
- Report layout and sections remain identical across both flows â€” the only difference is the inclusion of legal citation data
- Users select the option via a new toggle in the report generation UI

**Linear:** [ENG-1574](https://linear.app/qumis/issue/ENG-1574)

### Technical (3)

### Docs Authentication via OAuth

Users authenticated with the Qumis app now access docs.qumis.ai seamlessly â€” no separate login required.

- **OAuth 2.0 flow** with Qumis API as the identity provider, integrated into Mintlify's authentication system
- **Seamless experience** â€” users already logged into app.qumis.ai are automatically authenticated on docs
- **Group-based access control** â€” internal engineering docs (like these release notes) are restricted to `@qumis.ai` employees
- Post-login redirect support ensures users return to the exact docs page they were trying to access

**Linear:** [ENG-1531](https://linear.app/qumis/issue/ENG-1531)

### Feature Flag System

New infrastructure for conditional UI rendering, enabling controlled rollouts of features to specific environments or user groups.

- Beta feature flag system for toggling UI features (billing flow, signup flow) without redeployment
- Flags defined in configuration and checked at render time
- Foundation for gradual rollouts and A/B testing

**Linear:** [ENG-1574](https://linear.app/qumis/issue/ENG-1574)

### Improved Checklist Detection

The Coverage Table workflow now detects nested lists, repeatable sections, and complex hierarchies in insurance templates much more accurately.

- **Heuristic-based schema detection** â€” automatically identifies list fields from template patterns like "Location 1", plural names ("Scheduled Locations"), and indented hierarchies
- **Recursive nested list discovery** â€” handles deeply nested structures (e.g., Location > Building > Coverage) with proper parent-child relationships
- **Pre-distillation for batch inference** â€” new agents for document distillation and insights before schema detection
- **List preservation in distillation** â€” ensures numbered/bulleted lists survive the document processing pipeline
- Supports both annotated templates (with `[]` markers) and un-annotated templates (with numbered instances like "Location 1", "Building 1")

**Linear:** [ENG-1484](https://linear.app/qumis/issue/ENG-1484)

---

## Bug Fixes

### User-Facing (5)

### Chat and Report Scrolling

Fixed vertical scroll not working properly in chat messages and report panels â€” content would get stuck or jump unexpectedly.

**Linear:** [ENG-1579](https://linear.app/qumis/issue/ENG-1579)

### Edge Browser Scrolling

Added manual scroll handling for Edge browser where default scroll events were not bubbling correctly on chat, history, and workflow pages.

### Vault Document Preview

Fixed eye icon click in the document vault not opening the preview â€” caused by PDF.js worker not being configured globally.

**Linear:** [ENG-1536](https://linear.app/qumis/issue/ENG-1536)

### Seat Management in Admin Portal

Admin portal now shows the seat management UI even when an organization has 0 seats configured â€” previously the edit controls were hidden entirely.

**Linear:** [PSC-28](https://linear.app/qumis/issue/PSC-28)

### Proposal Generation

Fixed "service unavailable" error when generating proposals.

**Linear:** [ENG-1501](https://linear.app/qumis/issue/ENG-1501)

### Technical (5)

### Lambda Function Timeouts

Refactored the analysis callback endpoint to return 200 OK immediately and process data asynchronously via Sidekiq. Previously, long-running sync operations (Typesense indexing, ActionCable broadcasts, DB updates) caused the callback sender to time out after 5+ minutes.

**Linear:** [ENG-1493](https://linear.app/qumis/issue/ENG-1493)

### esbuild Bundling Crash

Removed `@opentelemetry/*` packages from the esbuild external list â€” they were not available in the Lambda runtime, causing `ERR_MODULE_NOT_FOUND` crashes during Lambda cold starts.

**Linear:** [ENG-1581](https://linear.app/qumis/issue/ENG-1581)

### Report Type Versioning

Fixed handling of different report type versions in the LLM Service to ensure the correct workflow is selected for policy fact analysis with and without legal citations.

**Linear:** [ENG-1574](https://linear.app/qumis/issue/ENG-1574)

### Search Indexing Memory

Added configurable text truncation for Typesense indexing (via `TRUNCATE_TYPESENSE` env var) to prevent OUT\_OF\_MEMORY errors on large documents.

### Callback Data Serialization

Fixed symbol/string key mismatches in callback data by adding `deep_stringify_keys` before enqueueing to Sidekiq.

---

## Improvements

### User-Facing (3)

### Help Center Link

All links to `help.qumis.ai` now redirect to `docs.qumis.ai` and open in a new tab.

**Linear:** [ENG-1571](https://linear.app/qumis/issue/ENG-1571)

### Chat Scrollbar UX

Enhanced scrollbar visibility and smooth scrolling behavior in chat panels.

### Report Loading Polish

Improved font weights, spacing, and visual feedback during report generation loading states.

### Technical (3)

### Configurable Credit Charging

Credit usage can be toggled via `CREDIT_USAGE_ENABLED` environment variable, defaulting to disabled for controlled rollout.

### Workflow Benchmarking

New timing and performance tracking for report generation workflow steps, enabling monitoring of processing bottlenecks.

### Large Callback Warnings

API now logs warnings when callback request payloads exceed the 6MB Lambda response limit, helping catch data size issues before they cause failures.

---

## Technical Details

### Deployment details

### Services Deployed

| Service | Commit | Files | Lines Changed |
|---------|--------|-------|---------------|
| API | `b2cce9d` | 57 | +2,848 / -397 |
| Web | `ecace62` | 68 | +3,580 / -519 |
| LLM Service | `27ae3fb` | 58 | +48,153 / -901 |

**Previous deployment:** January 29, 2026 (API/Web), January 15, 2026 (LLM Service)

> **Note:** LLM Service includes test fixtures and generated schema files, accounting for the high line count.

### Pull Requests (18 total)

**API (5 PRs)**
| PR | Description |
|----|-------------|
| [#324](https://github.com/qumisinc/qumis-api/pull/324) | Make credit usage configurable via environment variable |
| [#320](https://github.com/qumisinc/qumis-api/pull/320) | Chameleon analytics integration with hashed UID |
| [#319](https://github.com/qumisinc/qumis-api/pull/319) | Stripe billing updates â€” rename fields, credit config to DB |
| [#317](https://github.com/qumisinc/qumis-api/pull/317) | Fix Lambda timeout â€” move callbacks to Sidekiq + add workflow steps API |
| [#311](https://github.com/qumisinc/qumis-api/pull/311) | Onboarding v2 â€” database persistence, step tracking, API endpoints |

**Web (10 PRs)**
| PR | Description |
|----|-------------|
| [#461](https://github.com/qumisinc/qumis-web/pull/461) | Feature flag system for billing and signup flow toggles |
| [#460](https://github.com/qumisinc/qumis-web/pull/460) | Chat scrollbar visibility and smooth scrolling |
| [#459](https://github.com/qumisinc/qumis-web/pull/459) | Legal citations toggle for Policy Fact Analysis reports |
| [#457](https://github.com/qumisinc/qumis-web/pull/457) | Help center links redirected to docs.qumis.ai |
| [#453](https://github.com/qumisinc/qumis-web/pull/453) | Fix PDF.js worker config for vault document preview |
| [#451](https://github.com/qumisinc/qumis-web/pull/451) | Chameleon analytics integration |
| [#449](https://github.com/qumisinc/qumis-web/pull/449) | Fix Edge browser scroll issues on chat, history, and workflow pages |
| [#446](https://github.com/qumisinc/qumis-web/pull/446) | Field name hierarchy display and workflow progress UI |
| [#445](https://github.com/qumisinc/qumis-web/pull/445) | Stripe billing â€” rename labels, trial indicator, pricing page |
| [#444](https://github.com/qumisinc/qumis-web/pull/444) | Onboarding v2 â€” full guided flow with step persistence |

**LLM Service (3 PRs)**
| PR | Description |
|----|-------------|
| [#84](https://github.com/qumisinc/llm-service/pull/84) | Fix esbuild bundling â€” remove OpenTelemetry from externals |
| [#83](https://github.com/qumisinc/llm-service/pull/83) | Report type versioning for legal citations option |
| [#77](https://github.com/qumisinc/llm-service/pull/77) | Template schema detection â€” heuristic detection, recursive nesting, pre-distillation |

### Related Linear Tickets

**Major Features:**

- [ENG-1465](https://linear.app/qumis/issue/ENG-1465) â€” Onboarding v2: guided walkthrough with database persistence
- [ENG-1517](https://linear.app/qumis/issue/ENG-1517) â€” Workflow steps tracking from LLM Service to API
- [ENG-1518](https://linear.app/qumis/issue/ENG-1518) â€” Field name hierarchy display in checklist tables
- [ENG-1484](https://linear.app/qumis/issue/ENG-1484) â€” Template schema detection improvements for Coverage Table
- [ENG-1574](https://linear.app/qumis/issue/ENG-1574) â€” Legal citations option and feature flag system
- [ENG-1387](https://linear.app/qumis/issue/ENG-1387) â€” Chameleon analytics integration
- [ENG-1531](https://linear.app/qumis/issue/ENG-1531) â€” Docs OAuth authentication via Mintlify
- [ENG-1502](https://linear.app/qumis/issue/ENG-1502) â€” Credits system and Stripe billing updates

**Bug Fixes:**

- [ENG-1579](https://linear.app/qumis/issue/ENG-1579) â€” Chat and report vertical scroll issues
- [ENG-1536](https://linear.app/qumis/issue/ENG-1536) â€” Vault eye icon / PDF.js worker fix
- [PSC-28](https://linear.app/qumis/issue/PSC-28) â€” Admin portal seat management when seats is 0
- [ENG-1493](https://linear.app/qumis/issue/ENG-1493) â€” Lambda function timeout on analysis callbacks
- [ENG-1501](https://linear.app/qumis/issue/ENG-1501) â€” Proposal generation service unavailable
- [ENG-1581](https://linear.app/qumis/issue/ENG-1581) â€” esbuild bundling crash from OpenTelemetry externals

**Improvements:**

- [ENG-1571](https://linear.app/qumis/issue/ENG-1571) â€” Help center link to docs.qumis.ai

---

# qumis-cli Reference

Source: internal/engineering/operations/qumis-cli-reference

> **Info:** **qumis-cli** is our internal CLI tool for streamlining development and operations.
>
> Repository: [github.com/qumisinc/qumis-cli](https://github.com/qumisinc/qumis-cli)
>
> Not installed? See [Tools Setup](/internal/engineering/tools-setup)

## Quick Command Reference

### Service Deployment

```bash Development
qumis deploy api --env dev --reason "Feature update"
```

```bash QA
qumis deploy api --env qa --reason "QA testing"
```

```bash UAT
qumis deploy api --env uat --reason "UAT validation"
```

```bash Production
qumis deploy api --env prod --deploy-branch "release" --workflow-ref "release" --reason "Production release"
```

```bash Feature Branch
qumis deploy web \
  --deploy-branch "feature-branch" \
  --env "dev" \
  --reason "Test feature" \
  --workflow-ref "main"
```

### Service Operations

```bash Rails Console
qumis services exec api --env dev -- rails console
```

```bash Run Migrations
qumis services exec api --env dev -- rails db:migrate
```

```bash Production Console
qumis services exec api --env prod --reason "Debug" -- rails c
```

```bash Service Info
qumis services info api --env dev
qumis services info web --env prod
```

### AWS Operations

```bash Login to Dev
qumis aws login dev
```

```bash Login to Prod
qumis aws login prod
```

```bash Check Status
qumis aws status
```

```bash List Profiles
qumis aws profiles
```

```bash List Lambda Functions
qumis lambda list-functions --env dev
```

```bash Describe Lambda Function
qumis lambda describe-function CacheCreate --env dev
```

## Common Operations

### Development Workflow

### Feature Development

```bash
# 1. Sync your repository
qumis sync

# 2. Create feature branch
qumis feature user-auth --ticket ENG-456

# 3. Check status
qumis status

# 4. Create pull request
qumis pr create --title "Add user authentication"

# 5. View PR in browser
qumis pr view
```

### Quick Fixes

```bash
# 1. Switch to branch
qumis switch main

# 2. Pull latest changes
qumis sync

# 3. Create hotfix branch
qumis feature hotfix-bug

# 4. Deploy to dev for testing
qumis deploy api --env dev --reason "Test hotfix"
```

### Rails Console Access

> **Warning:** Production console access requires audit logging. Always provide a clear reason.

### Development

```bash
# Simple console access
qumis services exec api --env dev -- rails console

# Run specific commands
qumis services exec api --env dev -- rails runner "puts User.count"

# Check migrations
qumis services exec api --env dev -- rails db:migrate:status
```

### Production

```bash
# Production requires reason (interactive confirmation)
qumis services exec api \
  --env prod \
  --reason "Investigate customer issue #12345" \
  -- rails console

# Run read-only queries
qumis services exec api \
  --env prod \
  --reason "Check user count for metrics" \
  -- rails runner "puts User.count"
```

### Database Operations

```bash Run Migrations (Dev)
qumis services exec api --env dev -- rails db:migrate
```

```bash Run Migrations (UAT)
qumis services exec api --env uat -- rails db:migrate
```

```bash Run Migrations (Production)
qumis services exec api --env prod --reason "Apply migration" -- rails db:migrate
```

```bash Check Migration Status
qumis services exec api --env dev -- rails db:migrate:status
```

```bash Rollback Migration
qumis services exec api --env dev -- rails db:rollback STEP=1
```

```bash Seed Database (Dev Only)
qumis services exec api --env dev -- rails db:seed
```

### Environment Variables

#### List Configured Variables and Secrets

List environment variables and secrets configured in GitHub for each service:

```bash
# API service - production
qumis vars list api --env prod
qumis secrets list api --env prod

# Web service - production
qumis vars list web --env prod
qumis secrets list web --env prod
```

> **Note:**&#x20;
>
> - `qumis vars list` shows environment variable names and values from GitHub
> - `qumis secrets list` shows secret names only (values are not accessible for security)
> - Variables and secrets are not directly modified via qumis-cli; use AWS Console or IaC

#### Inspect Running Environment Variables in Production

Use these commands to inspect the actual environment variables running in production containers:

```bash
# API service
qumis services exec api \
  --env prod \
  --reason "Print ENV vars" \
  --confirm "prod" \
  -- env | grep -E "^[A-Z_]+=.*" | sort

# Web service
qumis services exec web \
  --env prod \
  --reason "Print ENV vars" \
  --confirm "prod" \
  -- env | grep -E "^[A-Z_]+=.*" | sort
```

**Command breakdown:**

- `qumis services exec [service]` - Execute command in service container
- `--env prod` - Target production environment
- `--reason "..."` - Audit trail reason (required for prod)
- `--confirm "prod"` - Production safety confirmation
- `-- env` - Run env command inside container
- `grep -E "^[A-Z_]+=.*"` - Filter for uppercase environment variables
- `sort` - Alphabetically sort output for easier reading

### Monitoring & Debugging

```bash
# Check service health
qumis services info api --env prod

# View Lambda functions
qumis lambda list-functions --env prod

# Get function details
qumis lambda describe-function llm-api-Function2 --env prod

# AWS authentication status
qumis aws status
```

## Command Options

### Global Flags

| Flag | Description | Example |
|------|-------------|---------|
| `--env` | Target environment | `dev`, `qa`, `uat`, `prod` |
| `--reason` | Audit log reason (required for prod) | `"Fix bug ENG-123"` |
| `--interact` | Interactive confirmation (auto for prod) | N/A |
| `--profile` | AWS profile override | `qumis_dev` |

### Environment Mapping

| Environment | AWS Account | Profile | Confirmation |
|-------------|------------|---------|--------------|
| `dev` | 080970846004 | qumis\_dev | No |
| `qa` | 340452546718 | qumis\_qa | No |
| `uat` | 499854674638 | qumis\_uat | No |
| `prod` | 729033428609 | qumis\_prod | Yes (interactive) |

## Git Operations

### Branch Management

```bash Create Feature Branch
qumis feature my-feature
qumis feature my-feature --ticket ENG-123
```

```bash Switch Branches
qumis switch main
qumis switch feature-branch
qumis switch ENG-123  # Switch by ticket ID
```

```bash Sync with Remote
qumis sync  # Fetches and prunes
```

### GitHub Integration

```bash
# Open in browser
qumis open pr         # Current PR
qumis open branch     # Current branch

# Pull request operations
qumis pr create --title "Title" --description "Description"
qumis pr view
```

## Troubleshooting Commands

### Diagnostics

```bash
# Run system diagnostics
qumis doctor

# Check configuration
qumis config
qumis config github.token  # View specific (masked)

# List all commands
qumis commands
qumis commands --category "Local Development"
```

### Common Issues

### AWS authentication expired

```bash
# Re-authenticate
qumis aws login dev

# Check status
qumis aws status
```

### GitHub token issues

```bash
# Reconfigure token
qumis config github.token <new-token>

# Verify with
qumis doctor
```

### Command not found

```bash
# Check installation
which qumis

# Reinstall if needed
cd /path/to/qumis-cli
make deploy
```

## Advanced Usage

### Interactive Mode

qumis-cli supports interactive prompting for missing arguments:

```bash
# Will prompt for service and environment
qumis deploy

# Will prompt for environment
qumis services exec api

# Bypass prompts with flags
qumis deploy api --env dev --reason "Deploy" --non-interactive
```

### Shell Aliases

If you have shell integration enabled:

```bash
# Short aliases
q status      # Same as: qumis status
q sync        # Same as: qumis sync
q pr view     # Same as: qumis pr view
```

### Repository Tools

```bash
# Pack repository for AI tools
qumis pack --output context.xml

# Copy to clipboard (macOS)
qumis pack --stdout | pbcopy
```

## Service-Specific Commands

### API Service

```bash
# Rails-specific commands
qumis services exec api --env dev -- rails generate model User
qumis services exec api --env dev -- bundle install
qumis services exec api --env dev -- rake db:create
qumis services exec api --env dev -- rspec
```

### Web Service

```bash
# Node.js/Next.js commands
qumis services exec web --env dev -- npm install
qumis services exec web --env dev -- npm run build
qumis services exec web --env dev -- npm test
```

### LLM Service

```bash
# Python/ML commands
qumis services exec llm --env dev -- python manage.py
qumis services exec llm --env dev -- pip list
```

### Report Operations

Download documents from a Qumis report into a zip file.

```bash Download from Local
qumis reports documents <report_id>
```

```bash Download from Production
qumis reports documents <report_id> --env prod
```

```bash Download to Specific Directory
qumis reports documents <report_id> --output ~/Downloads
```

```bash Force Download (Stuck Reports)
qumis reports documents <report_id> --env prod --force
```

**Flags:**

| Flag | Short | Default | Description |
|------|-------|---------|-------------|
| `--env` | `-e` | `local` | Environment to use (`local`, `dev`, `qa`, `uat`, `prod`) |
| `--output` | `-o` | `.` | Output directory for the zip file |
| `--force` | `-f` | `false` | Download even if report is still processing |

> **Note:** The `--force` flag is useful when a report is stuck in a processing state. However, documents may not be available until the report processing completes.

**Example Output:**

```
â€¢ Fetching report abc-123-def...
â€¢ Found 5 documents
  -> policy-document.pdf (2.1 MB)
  -> endorsement-1.pdf (450 KB)
  -> endorsement-2.pdf (380 KB)
  -> schedule.xlsx (125 KB)
  -> certificate.pdf (89 KB)
âœ“ Downloaded 5/5 documents to ./abc-123-def.zip (3.1 MB)

Zip file saved to: ./abc-123-def.zip
```

## Best Practices

1. **Always provide clear reasons** for production operations
2. **Test in dev/UAT first** before production deployments
3. **Use ticket numbers** in deployment reasons for traceability
4. **Run `qumis sync`** before starting new work
5. **Check `qumis status`** to see current branch and PR status
6. **Use `qumis doctor`** to diagnose configuration issues

## Scripting with qumis-cli

### Deployment Script Example

```bash
#!/bin/bash
# deploy-to-uat.sh

set -e

echo "Deploying to UAT..."

# Ensure we're on the right branch
git checkout release

# Sync with remote
qumis sync

# Deploy to UAT (or production)
qumis deploy api \
  --env uat \
  --reason "UAT deployment for sprint review" \
  --deploy-branch "release" \
  --workflow-ref "release"

# Note: For production, you'll be prompted to confirm by typing:
# - The deploy branch (e.g., "release")
# - The environment ("prod")

# Verify deployment
qumis services info api --env uat

echo "UAT deployment complete!"
```

### Health Check Script

```bash
#!/bin/bash
# health-check.sh

ENVIRONMENTS=("dev" "qa" "uat" "prod")

for ENV in "${ENVIRONMENTS[@]}"; do
  echo "Checking $ENV..."
  qumis services info api --env $ENV || echo "$ENV is down!"
done
```

## Additional Resources

- [qumis-cli GitHub Repository](https://github.com/qumisinc/qumis-cli)
- [Rails Commands Guide](/internal/engineering/operations/rails-commands)
- [Production Deployment](/internal/engineering/deployment/production-deployment)
- [Tools Setup](/internal/engineering/tools-setup)

---

# Rails Commands via qumis-cli

Source: internal/engineering/operations/rails-commands

This guide covers how to run Rails commands on our API service across different environments using qumis-cli.

## Basic Syntax

```bash
qumis services exec api \
  --env [environment] \
  --reason "[reason for audit log]" \
  --confirm "[environment]" \  # Required for production only
  -- [rails command]
```

> **Warning:** **Production commands** require:
>
> - `--reason` flag with clear explanation
> - `--confirm prod` flag for safety
> - Audit log entry is automatically created

## Common Rails Commands

### Rails Console

### Development

```bash
# Open interactive console
qumis services exec api --env dev -- rails console

# Short version
qumis services exec api --env dev -- rails c
```

### Production

```bash
# Production console (requires confirmation)
qumis services exec api \
  --env prod \
  --reason "Debug customer issue #12345" \
  --confirm prod \
  -- rails console

# Read-only console (safer)
qumis services exec api \
  --env prod \
  --reason "Investigate data issue" \
  --confirm prod \
  -- rails console --sandbox
```

### Database Migrations

### Check Migration Status

```bash
# Development
qumis services exec api --env dev -- rails db:migrate:status

# Production
qumis services exec api \
  --env prod \
  --reason "Check migration status before deployment" \
  --confirm prod \
  -- rails db:migrate:status
```

### Run Migrations

```bash
# Development
qumis services exec api --env dev -- rails db:migrate

# UAT (test before production)
qumis services exec api --env uat -- rails db:migrate

# Production
qumis services exec api \
  --env prod \
  --reason "Apply migration for feature ENG-123" \
  --confirm prod \
  -- rails db:migrate
```

### Rollback if Needed

```bash
# Rollback last migration
qumis services exec api --env dev -- rails db:rollback

# Rollback specific number of migrations
qumis services exec api --env dev -- rails db:rollback STEP=2

# Production rollback (use with extreme caution)
qumis services exec api \
  --env prod \
  --reason "ROLLBACK: Migration causing issues" \
  --confirm prod \
  -- rails db:rollback
```

### Rails Runner

Execute Ruby code in the Rails environment:

```bash
# Simple commands
qumis services exec api --env dev -- rails runner "puts User.count"

# Complex scripts
qumis services exec api --env dev -- rails runner "User.where(created_at: 1.day.ago..Time.now).count"

# Production queries
qumis services exec api \
  --env prod \
  --reason "Get metrics for daily report" \
  --confirm prod \
  -- rails runner "puts User.active.count"
```

### Database Tasks

### Development Only

```bash
# Create database
qumis services exec api --env dev -- rails db:create

# Drop database (DANGER!)
qumis services exec api --env dev -- rails db:drop

# Reset database (drop, create, migrate, seed)
qumis services exec api --env dev -- rails db:reset

# Load schema
qumis services exec api --env dev -- rails db:schema:load

# Seed database
qumis services exec api --env dev -- rails db:seed
```

### Safe for All Environments

```bash
# Check database version
qumis services exec api --env dev -- rails db:version

# Run specific migration
qumis services exec api --env dev -- rails db:migrate:up VERSION=20240101120000

# Check pending migrations
qumis services exec api --env dev -- rails runner "puts ActiveRecord::Base.connection.migration_context.needs_migration?"
```

## Data Queries and Manipulation

### Safe Read Operations

```bash Count Records
qumis services exec api --env prod \
  --reason "Get user metrics" \
  --confirm prod \
  -- rails runner "puts User.count"
```

```bash Find Specific Records
qumis services exec api --env prod \
  --reason "Check specific user status" \
  --confirm prod \
  -- rails runner "puts User.find_by(email: 'user@example.com')&.attributes"
```

```bash Generate Reports
qumis services exec api --env prod \
  --reason "Generate usage report" \
  --confirm prod \
  -- rails runner "
    puts 'Daily Active Users: ' + User.where(last_sign_in_at: 1.day.ago..Time.now).count.to_s
  "
```

### Data Modifications

> **Warning:** **DANGER**: Data modifications in production should be:
>
> - Tested in UAT first
> - Approved by team lead
> - Wrapped in transactions when possible
> - Backed up before execution

```bash
# UAT testing first
qumis services exec api --env uat -- rails runner "
  User.find_by(email: 'test@example.com')&.update(status: 'active')
"

# Production update (with extreme caution)
qumis services exec api \
  --env prod \
  --reason "Fix user status per support ticket #789" \
  --confirm prod \
  -- rails runner "
    ActiveRecord::Base.transaction do
      user = User.find_by(email: 'user@example.com')
      if user
        user.update!(status: 'active')
        puts 'Updated user ' + user.id.to_s
      else
        puts 'User not found'
        raise ActiveRecord::Rollback
      end
    end
  "
```

## Rake Tasks

### Built-in Tasks

```bash List All Rake Tasks
qumis services exec api --env dev -- rails -T
```

```bash Stats
qumis services exec api --env dev -- rake stats
```

```bash Routes
qumis services exec api --env dev -- rake routes
```

```bash Middleware
qumis services exec api --env dev -- rake middleware
```

### Custom Rake Tasks

```bash
# Run custom task
qumis services exec api --env dev -- rake custom:task

# With arguments
qumis services exec api --env dev -- rake data:import[file.csv]

# Production rake task
qumis services exec api \
  --env prod \
  --reason "Run scheduled cleanup task" \
  --confirm prod \
  -- rake maintenance:cleanup
```

## Testing Commands

### Running Tests

```bash Run All Tests
qumis services exec api --env dev -- rails test
```

```bash Run Specific Test File
qumis services exec api --env dev -- rails test test/models/user_test.rb
```

```bash Run RSpec Tests
qumis services exec api --env dev -- rspec
```

```bash Run Specific RSpec File
qumis services exec api --env dev -- rspec spec/models/user_spec.rb
```

```bash Run Specific Test Line
qumis services exec api --env dev -- rspec spec/models/user_spec.rb:42
```

### Test Database

```bash
# Prepare test database
qumis services exec api --env dev -- rails db:test:prepare

# Load test fixtures
qumis services exec api --env dev -- rails db:fixtures:load
```

## Cache and Assets

### Cache Management

```bash Clear Rails Cache (Dev)
qumis services exec api --env dev -- rails cache:clear
```

```bash Clear Rails Cache (Production)
qumis services exec api \
  --env prod \
  --reason "Clear cache after configuration change" \
  --confirm prod \
  -- rails cache:clear
```

### Asset Management

```bash
# Precompile assets
qumis services exec api --env dev -- rails assets:precompile

# Clean assets
qumis services exec api --env dev -- rails assets:clean

# Clobber assets (remove all)
qumis services exec api --env dev -- rails assets:clobber
```

## Debugging and Troubleshooting

### Check Application State

```bash
# Rails environment
qumis services exec api --env dev -- rails runner "puts Rails.env"

# Database connection
qumis services exec api --env dev -- rails runner "puts ActiveRecord::Base.connection.active?"

# Loaded gems
qumis services exec api --env dev -- rails runner "puts Gem.loaded_specs.keys.sort"

# Environment variables
qumis services exec api --env dev -- rails runner "puts ENV.select { |k,v| k.start_with?('RAILS_') }"
```

### Performance Analysis

```bash
# Database query analysis
qumis services exec api --env dev -- rails runner "
  ActiveRecord::Base.logger = Logger.new(STDOUT)
  User.includes(:posts).where(active: true).limit(10).each { |u| u.posts.count }
"

# Memory usage
qumis services exec api --env dev -- rails runner "
  puts 'Memory: ' + (`ps -o rss= -p \#{Process.pid}`.to_i / 1024).to_s + ' MB'
"
```

## Best Practices

### Safety Guidelines

1. **Always test in development first**
   ```bash
   # Test in dev
   qumis services exec api --env dev -- rails runner "YOUR_COMMAND"
   # Then in UAT
   qumis services exec api --env uat -- rails runner "YOUR_COMMAND"
   # Finally in production
   qumis services exec api --env prod --reason "Tested in UAT" --confirm prod -- rails runner "YOUR_COMMAND"
   ```

2. **Use transactions for data modifications**
   ```ruby
   ActiveRecord::Base.transaction do
     # Your changes here
     # Will rollback if any error occurs
   end
   ```

3. **Use sandbox mode for exploration**
   ```bash
   qumis services exec api --env prod --reason "Safe exploration" --confirm prod -- rails console --sandbox
   ```

### Audit Log Best Practices

Good reason examples:

- âœ… "Debug customer issue #12345"
- âœ… "Apply migration for feature ENG-789"
- âœ… "Generate monthly usage report for finance"
- âœ… "Fix data inconsistency per bug report #456"

Bad reason examples:

- âŒ "Testing"
- âŒ "Fix stuff"
- âŒ "Running command"

### Performance Considerations

1. **Avoid N+1 queries**
   ```ruby
   # Bad
   User.all.each { |u| puts u.posts.count }

   # Good
   User.includes(:posts).each { |u| puts u.posts.count }
   ```

2. **Use batch processing for large datasets**
   ```ruby
   User.find_each(batch_size: 1000) do |user|
     # Process user
   end
   ```

3. **Add timeouts for long-running operations**
   ```ruby
   Timeout::timeout(300) do
     # Operation that shouldn't take more than 5 minutes
   end
   ```

## Common Patterns

### Daily Operations Check

```bash
#!/bin/bash
# daily-check.sh

echo "Checking API health across environments..."

for ENV in dev qa uat prod; do
  echo "Environment: $ENV"

  if [ "$ENV" = "prod" ]; then
    qumis services exec api \
      --env prod \
      --reason "Daily health check" \
      --confirm prod \
      -- rails runner "puts 'DB Connected: ' + ActiveRecord::Base.connection.active?.to_s"
  else
    qumis services exec api --env $ENV -- rails runner "puts 'DB Connected: ' + ActiveRecord::Base.connection.active?.to_s"
  fi
done
```

### Data Export Script

```bash
# Export user data for analysis
qumis services exec api \
  --env prod \
  --reason "Export data for monthly analytics" \
  --confirm prod \
  -- rails runner "
    require 'csv'
    CSV.open('/tmp/users_export.csv', 'w') do |csv|
      csv << ['ID', 'Email', 'Created At', 'Status']
      User.find_each do |user|
        csv << [user.id, user.email, user.created_at, user.status]
      end
    end
    puts 'Export complete: /tmp/users_export.csv'
  "
```

## Troubleshooting

### Command times out

Long-running commands may timeout. Consider:

- Running in background with nohup
- Breaking into smaller batches
- Using rake tasks instead of runner

### Memory errors

For memory-intensive operations:

- Process in batches
- Use `find_each` instead of `all`
- Clear cache between operations

### Permission denied

Ensure you have:

- Proper AWS credentials
- Access to the environment
- Required permissions in qumis-cli

## Additional Resources

- [qumis-cli Reference](/internal/engineering/operations/qumis-cli-reference)
- [Production Deployment](/internal/engineering/deployment/production-deployment)
- [Database Best Practices](https://guides.rubyonrails.org/active_record_querying.html)
- [Rails Command Line Guide](https://guides.rubyonrails.org/command_line.html)

---

# Visual Regression Testing

Source: internal/engineering/operations/visual-regression-testing

Playwright + Chromatic visual regression tests detect UI changes across builds using automated browser testing and visual diffing.

> **Info:** **For comprehensive documentation** including viewport strategy, architecture details, and test structure, see the [qumis-web README](https://github.com/qumisinc/qumis-web/blob/main/README.md).

## Quick Start

### Install Playwright Browsers

```bash
pnpm playwright:install
```

Installs Chromium and dependencies needed to run tests.

### Set Chromatic Project Token

Set your Chromatic project token as an environment variable:

```bash
export CHROMATIC_PROJECT_TOKEN=chpt_your_token_here
```

Or add to your `.env` file (recommended):

```bash
CHROMATIC_PROJECT_TOKEN=chpt_your_token_here
```

### Run Tests Locally

Test without Chromatic integration:

```bash
pnpm playwright:test
```

### Run Chromatic Visual Regression

Upload screenshots to Chromatic for visual diffing:

```bash
pnpm chromatic
```

## Common Commands

### Local Development

```bash Run all tests locally
pnpm playwright:test
```

```bash Run tests in UI mode (debugging)
pnpm playwright:ui
```

```bash Run specific test file
pnpm playwright:test chromatic-visual.spec.ts
```

### Chromatic Integration

```bash Upload to Chromatic (uses .env token)
pnpm chromatic
```

```bash Upload with explicit token
pnpm exec chromatic --playwright --project-token=chpt_your_token_here
```

## CI/CD Workflow

### Automatic Triggers

The Chromatic workflow runs automatically on:

- Push to `main` or `release` branches
- Pull requests to `main` or `release` branches
- Manual workflow dispatch

### Manual Trigger via GitHub CLI

```bash Trigger on Current Branch
gh workflow run chromatic.yml --ref "$(git rev-parse --abbrev-ref HEAD)"
```

```bash Force Rebuild (Skip Cache)
gh workflow run chromatic.yml \
  --ref "$(git rev-parse --abbrev-ref HEAD)" \
  --field force_rebuild=true
```

```bash Watch Workflow Status
gh run watch
```

### Manual Trigger via GitHub UI

### Navigate to Workflow

Go to **Actions** â†’ **Chromatic** workflow â†’ **Run workflow**

### Select Branch

Select your branch from the dropdown

### Configure Options

Optionally check **Force Chromatic to rebuild** to skip cache

### Run Workflow

Click **Run workflow** to start the build

## Test Configuration

### Default Viewport Coverage

By default, tests run on **TIER1 + TIER2 viewports** (7 total):

- **TIER1** (4 viewports): Primary business workflows - desktop Full HD, laptops, windowed displays
- **TIER2** (3 viewports): Extended desktop coverage - QHD, ultrawide, legacy laptops

See `playwright.config.ts` in qumis-web for active configuration.

### Performance Considerations

- **TIER1 only** (4 viewports): ~2-4 minutes per test suite
- **TIER1 + TIER2** (7 viewports): ~4-7 minutes per test suite
- **All tiers** (11 viewports): ~7-12 minutes per test suite

> **Tip:** For PR builds, consider using TIER1 only for fast feedback. Use TIER1 + TIER2 for main/release branches.

## Resources

Full documentation on viewport strategy and test architecture

Official Playwright documentation

Chromatic visual regression documentation

View the full CI/CD workflow configuration

## Troubleshooting

### Tests failing locally but passing in CI

- Ensure you're using the same Node/pnpm versions as CI
- Run `pnpm playwright:install` to update browser binaries
- Clear Playwright cache: `rm -rf ~/.cache/ms-playwright`

### Chromatic token not found

- Verify `CHROMATIC_PROJECT_TOKEN` is set in your environment
- Check your `.env` file in the qumis-web root directory
- Get token from Chromatic project settings

### Visual diffs showing unexpected changes

- Review changes in Chromatic dashboard
- Check if viewport configuration changed
- Verify CSS/component changes are intentional
- Accept baseline if changes are expected

> **Warning:** **Production token required**: The `CHROMATIC_PROJECT_TOKEN` secret must be set in GitHub repository settings for CI/CD workflows to run.

---

# AWS Environments

Source: internal/engineering/infrastructure/aws-environments

This guide provides a comprehensive overview of our AWS environments, their purposes, and access patterns.

## AWS Console Access

> **Info:** **AWS SSO Portal**: Access all AWS accounts through the single sign-on portal
>
> [**https://qumis.awsapps.com/start/#/?tab=accounts**](https://qumis.awsapps.com/start/#/?tab=accounts)
>
> This is the main entrypoint for accessing AWS consoles across all environments. Bookmark this URL for quick access.

**Using the AWS SSO Portal:**

### Navigate to AWS SSO Portal

Go to the [AWS SSO Portal](https://qumis.awsapps.com/start/#/?tab=accounts)

### Select Environment

Select the appropriate environment from the list (e.g., "Qumis - Production" as shown in the screenshot)

### Access Console

Click **"Management console"** or **"AdministratorAccess"** to access the AWS Console for that environment

### View Available Environments

You'll see all environments you have permissions to access, including Development, QA, UAT, Production, and Shared Services

> **Note:** The environments displayed depend on your IAM permissions. New engineers typically start with access to Dev, QA, and UAT. Production access requires senior engineer permissions.

## Environment Overview

### Deployment Environments

> **Info:** These environments are used for deploying and running our applications at different stages of the development lifecycle.

| Environment | Account ID | Email | Purpose | Access Level |
|------------|------------|--------|---------|--------------|
| **Development** | 080970846004 | shiv+aws-dev@qumis.ai | Active development and testing | All engineers |
| **QA** | 340452546718 | shiv+aws-qa@qumis.ai | Quality assurance testing | All engineers |
| **UAT** | 499854674638 | shiv+aws-uat@qumis.ai | User acceptance testing | All engineers |
| **Production** | 729033428609 | shiv+aws-production@qumis.ai | Live production environment | Senior engineers |

### Infrastructure Environment

| Environment | Account ID | Email | Purpose | Access Level |
|------------|------------|--------|---------|--------------|
| **Shared Services** | 355867115367 | shiv+aws-shared-service@qumis.ai | Cross-environment infrastructure, CI/CD, shared resources | DevOps team |

> **Warning:** **Shared Services** is not a deployment environment. It contains infrastructure that supports all other environments (e.g., CI/CD pipelines, artifact storage, shared databases).

## Environment Details

### Development (dev)

**Account ID**: 080970846004
**AWS Profile**: `qumis_dev`
**Purpose**: Active development and experimentation

**Characteristics**:

- Frequent deployments
- Experimental features
- Test data only
- Relaxed security policies
- Auto-shutdown for cost savings

**Common Operations**:

```bash Login
qumis aws login dev
```

```bash Deploy
qumis deploy api --env dev --reason "Test new feature"
```

```bash Access Console
qumis services exec api --env dev -- rails console
```

### QA Environment

**Account ID**: 340452546718
**AWS Profile**: `qumis_qa`
**Purpose**: Automated and manual QA testing

**Characteristics**:

- Stable builds for testing
- Automated test suites run here
- QA team validation
- Production-like configuration
- Regular data refreshes from production (sanitized)

**Common Operations**:

```bash Login
qumis aws login qa
```

```bash Deploy for QA Testing
qumis deploy api --env qa --reason "QA testing sprint 23"
```

```bash Check Logs
aws logs tail /aws/lambda/qumis-api-qa --profile qumis_qa
```

### UAT Environment

**Account ID**: 499854674638
**AWS Profile**: `qumis_uat`
**Purpose**: User acceptance testing and staging

**Characteristics**:

- Production mirror
- Stakeholder demos
- Final testing before production
- Production-like data (sanitized)
- Same configuration as production

**Common Operations**:

```bash Login
qumis aws login uat
```

```bash Deploy Release Candidate
qumis deploy api --env uat --reason "Release candidate v1.2.3"
```

```bash Verify Deployment
qumis services info api --env uat
```

### Production Environment

**Account ID**: 729033428609
**AWS Profile**: `qumis_prod`
**Purpose**: Live production environment serving customers

**Characteristics**:

- Strict access control
- Change approval required
- Full monitoring and alerting
- Regular backups
- High availability configuration
- Audit logging for all operations

**Common Operations**:

```bash Login (Requires Elevated Permissions)
qumis aws login prod
```

```bash Deploy with Confirmation
qumis deploy api \
  --env prod \
  --reason "Release v1.2.3 - ENG-123" \
  --confirm prod
```

```bash Production Console (With Audit Log)
qumis services exec api \
  --env prod \
  --reason "Debug customer issue #456" \
  --confirm prod \
  -- rails console
```

### Shared Services

**Account ID**: 355867115367
**AWS Profile**: `qumis_shared`
**Purpose**: Infrastructure and services shared across environments

**Components**:

- CI/CD pipelines (GitHub Actions runners)
- Docker registry (ECR)
- Artifact storage (S3)
- Secrets management (Parameter Store)
- DNS management (Route53)
- Certificate management (ACM)

> **Warning:** Direct access to Shared Services is restricted to DevOps team members. Most engineers interact with it indirectly through CI/CD pipelines.

## Access Management

### AWS SSO Configuration

### Access AWS Console

**Primary Method**: Use the AWS SSO Portal to access the AWS Console for any environment:

[**https://qumis.awsapps.com/start/#/?tab=accounts**](https://qumis.awsapps.com/start/#/?tab=accounts)

This portal provides direct browser access to all AWS accounts you have permissions for.

### Configure SSO Profile

For CLI access, configure your `~/.aws/config` file with the appropriate SSO profiles.

> **Info:** See the complete AWS configuration template in [Tools Setup â†’ AWS Configuration](/internal/engineering/tools-setup#aws-configuration).
>
> The configuration includes all environment profiles (dev, qa, uat, prod, sharedservices) using:
>
> - SSO URL: `https://qumis.awsapps.com/start/`
> - Region: `us-east-2`

### Login to Environment

```bash
# Using qumis-cli
qumis aws login dev

# Or directly with AWS CLI
aws sso login --profile qumis_dev
```

### Verify Access

```bash
# Check current identity
aws sts get-caller-identity --profile qumis_dev

# List S3 buckets
aws s3 ls --profile qumis_dev
```

### Permission Levels

| Role | Dev | QA | UAT | Prod | Shared Services |
|------|-----|----|----|------|-----------------|
| Junior Engineer | Full | Full | Read | No | No |
| Engineer | Full | Full | Full | Read | No |
| Senior Engineer | Full | Full | Full | Full | Read |
| DevOps | Full | Full | Full | Full | Full |
| Team Lead | Full | Full | Full | Full | Full |

## Service Architecture

### Lambda Functions

Each environment runs Lambda functions for our services:

```
qumis-api-{environment}
qumis-web-{environment}
qumis-llm-{environment}
```

View functions:

```bash
# List all Lambda functions
qumis lambda list-functions --env dev
qumis lambda list-functions --env prod

# Get function details
qumis lambda describe-function qumis-api --env dev
```

### RDS Databases

- **Dev**: Single instance, minimal resources
- **QA**: Single instance, production-like config
- **UAT**: Multi-AZ for testing failover
- **Production**: Multi-AZ with read replicas

### S3 Buckets

Naming convention: `qumis-{service}-{environment}-{region}`

Examples:

- `qumis-api-dev-us-east-1`
- `qumis-api-prod-us-east-1`
- `qumis-uploads-prod-us-east-1`

## Monitoring by Environment

### CloudWatch Log Groups

Log group naming: `/aws/lambda/qumis-{service}-{environment}`

```bash
# View logs for different environments
aws logs tail /aws/lambda/qumis-api-dev --profile qumis_dev
aws logs tail /aws/lambda/qumis-api-prod --profile qumis_prod --follow
```

### Metrics and Alarms

- **Dev**: Basic metrics, no alarms
- **QA**: Standard metrics, test alarms
- **UAT**: Full metrics, staging alarms
- **Production**: Comprehensive metrics, critical alarms with PagerDuty integration

## Cost Management

### Environment Costs (Monthly Estimates)

| Environment | Typical Cost | Cost Controls |
|------------|--------------|---------------|
| Dev | $500-800 | Auto-shutdown, smaller instances |
| QA | $800-1200 | Scheduled scaling, cleanup jobs |
| UAT | $1500-2000 | On-demand scaling |
| Production | $5000-8000 | Reserved instances, Savings Plans |
| Shared Services | $300-500 | Minimal resources |

### Cost Optimization

**Development**:

- Auto-stop Lambda functions after hours
- Use spot instances where possible
- Regular cleanup of old resources

**Production**:

- Reserved instances for predictable workloads
- Auto-scaling based on demand
- Regular cost analysis and optimization

## Security Considerations

### Network Isolation

- Each environment has its own VPC
- No direct connectivity between environments
- Bastion hosts for emergency access
- VPN access for production (when required)

### Data Protection

- **Dev/QA**: Synthetic test data only
- **UAT**: Sanitized production data
- **Production**: Full encryption at rest and in transit
- **Backups**: Daily snapshots, 30-day retention

### Compliance

- SOC 2 compliance for production
- HIPAA compliance where applicable
- Regular security audits
- Penetration testing quarterly

## Emergency Procedures

### Environment Down

### Check AWS Status

Visit https://status.aws.amazon.com/ to check for AWS service outages

### Verify Access

Authenticate to the affected environment:

```bash
qumis aws login {env}
```

### Check Key Services

Verify Lambda, RDS, and S3 are operational:

```bash Lambda
qumis lambda list-functions --env {env}
```

```bash RDS
aws rds describe-db-instances --profile qumis_{env}
```

```bash S3
aws s3 ls --profile qumis_{env}
```

### Escalate if Needed

Contact DevOps team if services are down or unresponsive

### Cross-Environment Issues

If issues span multiple environments:

### Check Shared Services First

Verify the Shared Services account is operational as it supports all environments

### Verify CI/CD Pipeline Status

Check GitHub Actions and deployment pipeline health

### Check DNS and Certificates

Verify Route53 and ACM configurations are working correctly

### Review Recent Infrastructure Changes

Check CloudTrail for recent changes that may have affected multiple environments

## Best Practices

1. **Environment Progression**: Always deploy dev â†’ qa â†’ uat â†’ prod
2. **Access Principle**: Use minimum required permissions
3. **Cost Awareness**: Clean up unused resources regularly
4. **Security First**: Never copy production data to lower environments without sanitization
5. **Documentation**: Document any manual changes made to environments

## Additional Resources

- [AWS SSO Portal](https://qumis.awsapps.com/start/#/?tab=accounts) - Main entrypoint for AWS console access
- [CloudWatch Monitoring](/internal/engineering/infrastructure/cloudwatch-monitoring)
- [CloudWatch Alerts](/internal/engineering/infrastructure/cloudwatch-alerts)
- [Production Deployment](/internal/engineering/deployment/production-deployment)

---

# CloudWatch Monitoring

Source: internal/engineering/infrastructure/cloudwatch-monitoring

This guide covers how to use AWS CloudWatch to monitor our applications across all environments.

## Quick Access

### ECS Service Log Groups

> **Warning:** **Blue/Green Deployment Pattern**: We currently only have **blue** clusters active. Log groups follow the pattern:
> `ecs/blue/<environment>/<service>`
>
> Green clusters will be activated during blue/green deployments.

| Environment | Service | Log Group | AWS Profile |
|------------|---------|-----------|-------------|
| Dev | API | `ecs/blue/dev/api` | `qumis_dev` |
| Dev | Web | `ecs/blue/dev/web` | `qumis_dev` |
| Dev | Sidekiq | `ecs/blue/dev/sidekiq` | `qumis_dev` |
| QA | API | `ecs/blue/qa/api` | `qumis_qa` |
| QA | Web | `ecs/blue/qa/web` | `qumis_qa` |
| QA | Sidekiq | `ecs/blue/qa/sidekiq` | `qumis_qa` |
| UAT | API | `ecs/blue/uat/api` | `qumis_uat` |
| UAT | Web | `ecs/blue/uat/web` | `qumis_uat` |
| UAT | Sidekiq | `ecs/blue/uat/sidekiq` | `qumis_uat` |
| Production | API | `ecs/blue/prod/api` | `qumis_prod` |
| Production | Web | `ecs/blue/prod/web` | `qumis_prod` |
| Production | Sidekiq | `ecs/blue/prod/sidekiq` | `qumis_prod` |

### Lambda Function Log Groups (if applicable)

| Environment | Account ID | Log Group | AWS Profile |
|------------|------------|-----------|-------------|
| Dev | 080970846004 | `/aws/lambda/qumis-api-dev` | `qumis_dev` |
| QA | 340452546718 | `/aws/lambda/qumis-api-qa` | `qumis_qa` |
| UAT | 499854674638 | `/aws/lambda/qumis-api-uat` | `qumis_uat` |
| Production | 729033428609 | `/aws/lambda/qumis-api-prod` | `qumis_prod` |

### Quick Commands

#### ECS Services

```bash Tail Service Logs
# Tail ECS service logs in real-time (blue cluster)
aws logs tail ecs/blue/prod/api --profile qumis_prod --follow
aws logs tail ecs/blue/prod/web --profile qumis_prod --follow
aws logs tail ecs/blue/prod/sidekiq --profile qumis_prod --follow
```

```bash Search for Errors
# Search for errors across all services
for SERVICE in api web sidekiq; do
  echo "=== $SERVICE errors ==="
  aws logs filter-log-events \
    --log-group-name ecs/blue/prod/$SERVICE \
    --start-time $(date -u -d '1 hour ago' '+%s')000 \
    --filter-pattern "ERROR" \
    --profile qumis_prod \
    --max-items 5
done
```

```bash Monitor Sidekiq Jobs
aws logs tail ecs/blue/prod/sidekiq \
  --profile qumis_prod \
  --follow \
  --filter-pattern "perform"
```

```bash Helper Function
# Quick function for any environment
ecs_logs() {
  ENV=$1
  SERVICE=$2
  aws logs tail ecs/blue/$ENV/$SERVICE --profile qumis_$ENV --follow
}
# Usage: ecs_logs prod api
```

#### Lambda Functions

```bash Tail Lambda Logs
aws logs tail /aws/lambda/qumis-api-prod --profile qumis_prod --follow
```

```bash Search for Errors
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '1 hour ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod
```

## Accessing CloudWatch

### Via AWS Console

### Login to AWS

```bash
# Login via SSO
qumis aws login prod

# Or open console directly
aws sso login --profile qumis_prod
open https://console.aws.amazon.com/cloudwatch
```

### Navigate to Logs

1. Select **CloudWatch** service
2. Click **Logs â†’ Log groups** in left navigation
3. Search for `qumis` to find our log groups
4. Click on a log group to view streams

### View Log Streams

1. Log streams are organized by date and instance
2. Click on a stream to view logs
3. Use the search bar to filter logs
4. Adjust time range as needed

### Via AWS CLI

### Tail Logs

```bash
# Follow logs in real-time
aws logs tail /aws/lambda/qumis-api-dev --profile qumis_dev --follow

# Tail with filter
aws logs tail /aws/lambda/qumis-api-prod \
  --profile qumis_prod \
  --follow \
  --filter-pattern "ERROR"

# Tail specific time window
aws logs tail /aws/lambda/qumis-api-prod \
  --profile qumis_prod \
  --since 5m
```

### Search Logs

```bash
# Search for specific pattern
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --filter-pattern "Exception" \
  --profile qumis_prod

# Search with time range
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '1 hour ago' '+%s')000 \
  --end-time $(date -u '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod
```

### Get Specific Logs

```bash
# List log streams
aws logs describe-log-streams \
  --log-group-name /aws/lambda/qumis-api-prod \
  --order-by LastEventTime \
  --descending \
  --profile qumis_prod

# Get logs from specific stream
aws logs get-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --log-stream-name "2024/01/15/[$LATEST]abcd1234" \
  --start-from-head \
  --profile qumis_prod
```

## ECS-Specific Monitoring

### ECS Service Logs

### API Service

```bash
# Tail API logs (blue cluster)
aws logs tail ecs/blue/prod/api --profile qumis_prod --follow

# Search for specific endpoints
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/api \
  --filter-pattern "POST /api/v1/users" \
  --profile qumis_prod

# Check Rails errors
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/api \
  --filter-pattern "ActiveRecord::RecordNotFound" \
  --profile qumis_prod

# Monitor API response times
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/api \
  --filter-pattern "[Completed]" \
  --profile qumis_prod | grep -E "Completed [0-9]+ms"
```

### Web Service

```bash
# Tail web server logs (blue cluster)
aws logs tail ecs/blue/prod/web --profile qumis_prod --follow

# Check for JavaScript errors
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/web \
  --filter-pattern "Error" \
  --profile qumis_prod

# Monitor Next.js build issues
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/web \
  --filter-pattern "Build error" \
  --profile qumis_prod

# Check static asset serving
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/web \
  --filter-pattern "404" \
  --profile qumis_prod
```

### Sidekiq Service

```bash
# Monitor job processing (blue cluster)
aws logs tail ecs/blue/prod/sidekiq --profile qumis_prod --follow

# Check for failed jobs
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/sidekiq \
  --filter-pattern "FAILED" \
  --profile qumis_prod

# Monitor specific job types
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/sidekiq \
  --filter-pattern "EmailJob" \
  --profile qumis_prod

# Check job queue depths
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/sidekiq \
  --filter-pattern "queue" \
  --profile qumis_prod | grep -E "default|critical|low"

# Monitor retries
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/sidekiq \
  --filter-pattern "retry" \
  --profile qumis_prod
```

### ECS Task Monitoring

```bash
# Get ECS task list (blue cluster)
aws ecs list-tasks \
  --cluster blue-prod \
  --service-name api \
  --profile qumis_prod

# Describe a specific task
TASK_ARN=$(aws ecs list-tasks --cluster blue-prod --service-name api --profile qumis_prod --query 'taskArns[0]' --output text)
aws ecs describe-tasks \
  --cluster blue-prod \
  --tasks $TASK_ARN \
  --profile qumis_prod

# Get task logs by task ID
TASK_ID=$(echo $TASK_ARN | grep -oE '[a-f0-9]{32}' | head -1)
aws logs filter-log-events \
  --log-group-name ecs/blue/prod/api \
  --log-stream-name-prefix ecs/api/$TASK_ID \
  --profile qumis_prod
```

### Container Health Monitoring

```bash
# Check container health status (blue cluster)
aws ecs describe-services \
  --cluster blue-prod \
  --services api web sidekiq \
  --profile qumis_prod \
  --query 'services[*].[serviceName,healthCheckGracePeriodSeconds,deployments[0].runningCount]'

# Monitor container restarts
for SERVICE in api web sidekiq; do
  echo "=== $SERVICE container events ==="
  aws logs filter-log-events \
    --log-group-name ecs/blue/prod/$SERVICE \
    --filter-pattern "Container started" \
    --start-time $(date -u -d '24 hours ago' '+%s')000 \
    --profile qumis_prod \
    --query 'events | length(@)'
done
```

## Log Analysis

### Common Search Patterns

### Error Patterns

```bash
# All errors
--filter-pattern "ERROR"

# Specific error types
--filter-pattern "ActiveRecord::RecordNotFound"
--filter-pattern "NoMethodError"
--filter-pattern "Timeout::Error"

# Database errors
--filter-pattern "[ERROR] [Database]"
--filter-pattern "could not connect"

# Authentication errors
--filter-pattern "401"
--filter-pattern "Unauthorized"
```

### Performance

```bash
# Slow queries
--filter-pattern "[SLOW_QUERY]"
--filter-pattern "duration > 1000"

# Memory issues
--filter-pattern "Cannot allocate memory"
--filter-pattern "MemoryError"

# Timeouts
--filter-pattern "Timeout"
--filter-pattern "Task timed out"
```

### User Activity

```bash
# User logins
--filter-pattern "User logged in"
--filter-pattern "[LOGIN]"

# API calls
--filter-pattern "POST /api"
--filter-pattern "GET /api"

# Specific user
--filter-pattern "user_id=123"
--filter-pattern "email=user@example.com"
```

### CloudWatch Insights Queries

CloudWatch Insights provides powerful query capabilities:

```sql
-- Top 10 errors in last hour
fields @timestamp, @message
| filter @message like /ERROR/
| sort @timestamp desc
| limit 10

-- Request duration statistics
fields @duration, @requestId
| filter @type = "REPORT"
| stats avg(@duration), min(@duration), max(@duration) by bin(5m)

-- Errors by type
fields @message
| filter @message like /ERROR/
| parse @message /ERROR.*?(?<error_type>\w+Error)/
| stats count() by error_type

-- Memory usage over time
fields @timestamp, @memorySize, @maxMemoryUsed
| filter @type = "REPORT"
| stats avg(@maxMemoryUsed/@memorySize*100) as memory_percent by bin(5m)
```

## Metrics Monitoring

### Lambda Metrics

### Access Metrics

1. Navigate to CloudWatch â†’ Metrics
2. Select "Lambda" namespace
3. Choose metric dimension (By Function Name)
4. Select your function (e.g., `qumis-api-prod`)

### Key Metrics

- **Invocations**: Number of function executions
- **Errors**: Number of failed executions
- **Duration**: Execution time
- **Throttles**: Rate-limited invocations
- **Concurrent Executions**: Parallel executions

### Create Dashboard

```bash
# Get metrics via CLI
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Duration \
  --dimensions Name=FunctionName,Value=qumis-api-prod \
  --start-time $(date -u -d '1 hour ago' --iso-8601) \
  --end-time $(date -u --iso-8601) \
  --period 300 \
  --statistics Average,Maximum \
  --profile qumis_prod
```

### Custom Metrics

Our application logs custom metrics:

```bash
# Application performance
aws cloudwatch get-metric-statistics \
  --namespace Qumis/API \
  --metric-name ResponseTime \
  --start-time $(date -u -d '1 hour ago' --iso-8601) \
  --end-time $(date -u --iso-8601) \
  --period 300 \
  --statistics Average \
  --profile qumis_prod

# Business metrics
aws cloudwatch get-metric-statistics \
  --namespace Qumis/Business \
  --metric-name ActiveUsers \
  --start-time $(date -u -d '24 hours ago' --iso-8601) \
  --end-time $(date -u --iso-8601) \
  --period 3600 \
  --statistics Sum \
  --profile qumis_prod
```

## Real-time Monitoring

### Live Tail

```bash
#!/bin/bash
# live-monitor.sh

LOG_GROUP="/aws/lambda/qumis-api-prod"
PROFILE="qumis_prod"

echo "Monitoring $LOG_GROUP..."

# Color codes for different log levels
aws logs tail $LOG_GROUP \
  --profile $PROFILE \
  --follow \
  --format short \
  --filter-pattern "" | while read line; do
    if [[ $line == *"ERROR"* ]]; then
      echo -e "\033[31m$line\033[0m"  # Red for errors
    elif [[ $line == *"WARN"* ]]; then
      echo -e "\033[33m$line\033[0m"  # Yellow for warnings
    else
      echo "$line"
    fi
done
```

### Multi-Environment Monitoring

```bash
#!/bin/bash
# monitor-all-envs.sh

ENVIRONMENTS=("dev" "qa" "uat" "prod")
SEARCH_PATTERN="ERROR"

for ENV in "${ENVIRONMENTS[@]}"; do
  echo "=== Checking $ENV environment ==="

  LOG_GROUP="/aws/lambda/qumis-api-$ENV"
  PROFILE="qumis_$ENV"

  ERROR_COUNT=$(aws logs filter-log-events \
    --log-group-name $LOG_GROUP \
    --start-time $(date -u -d '1 hour ago' '+%s')000 \
    --filter-pattern "$SEARCH_PATTERN" \
    --profile $PROFILE \
    --query 'events | length(@)' \
    --output text)

  echo "$ENV: $ERROR_COUNT errors in last hour"
done
```

## Log Export and Analysis

### Export to S3

```bash
# Export logs to S3 for analysis
aws logs create-export-task \
  --log-group-name /aws/lambda/qumis-api-prod \
  --from $(date -u -d '7 days ago' '+%s')000 \
  --to $(date -u '+%s')000 \
  --destination qumis-logs-export \
  --destination-prefix production/$(date +%Y/%m/%d) \
  --profile qumis_prod
```

### Download for Local Analysis

```bash
# Download recent logs
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '1 hour ago' '+%s')000 \
  --profile qumis_prod \
  --output json > logs_$(date +%Y%m%d_%H%M%S).json

# Parse with jq
cat logs_*.json | jq '.events[].message' | grep ERROR
```

## Troubleshooting Patterns

### Debugging Production Issues

### Identify Error Pattern

```bash
# Get error summary
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '30 minutes ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod \
  --query 'events[].message' \
  --output text | sort | uniq -c | sort -rn
```

### Find Related Logs

```bash
# Get request ID from error
REQUEST_ID="abc-123-def"

# Find all logs for that request
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --filter-pattern "\"$REQUEST_ID\"" \
  --profile qumis_prod
```

### Check Metrics

```bash
# Check error rate
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Errors \
  --dimensions Name=FunctionName,Value=qumis-api-prod \
  --start-time $(date -u -d '1 hour ago' --iso-8601) \
  --end-time $(date -u --iso-8601) \
  --period 60 \
  --statistics Sum \
  --profile qumis_prod
```

### Common Issues

### No logs appearing

Check:

- Lambda function is actually running
- Correct log group name
- IAM permissions for CloudWatch
- Time range is correct

### Logs delayed

- CloudWatch has inherent delay (few seconds)
- Use `--follow` flag for real-time
- Check Lambda function isn't buffering logs

### Can't find specific error

- Use broader search pattern
- Check different time ranges
- Error might be in different log group
- Try CloudWatch Insights for complex queries

## Best Practices

### Log Hygiene

1. **Structured Logging**: Use JSON format for easier parsing
2. **Log Levels**: Use appropriate levels (ERROR, WARN, INFO, DEBUG)
3. **Correlation IDs**: Include request IDs for tracing
4. **Sensitive Data**: Never log passwords, tokens, or PII
5. **Performance**: Don't log in tight loops

### Monitoring Strategy

1. **Set up dashboards** for key metrics
2. **Create saved queries** for common investigations
3. **Export critical logs** for compliance
4. **Regular review** of error patterns
5. **Automate alerts** for critical issues

### Cost Management

1. **Set retention periods** appropriately:
   - Dev: 7 days
   - QA: 14 days
   - UAT: 30 days
   - Production: 90 days

2. **Use log filters** to reduce storage:
   ```bash
   # Only store errors and warnings in long-term storage
   aws logs put-retention-policy \
     --log-group-name /aws/lambda/qumis-api-dev \
     --retention-in-days 7 \
     --profile qumis_dev
   ```

## Useful Scripts

### ECS Service Monitor

```bash
#!/bin/bash
# ecs-monitor.sh

# Blue/Green deployment - currently only blue is active
ENV="prod"  # Change to dev, qa, uat as needed
CLUSTER="blue-${ENV}"
PROFILE="qumis_${ENV}"
SERVICES="api web sidekiq"

echo "ECS Service Monitor - $(date)"
echo "Cluster: $CLUSTER"
echo "=========================="

# Check service status
echo -e "\nService Status:"
aws ecs describe-services \
  --cluster $CLUSTER \
  --services $SERVICES \
  --profile $PROFILE \
  --query 'services[*].[serviceName,status,runningCount,desiredCount,pendingCount]' \
  --output table

# Check recent errors for each service
echo -e "\nRecent Errors (last hour):"
for SERVICE in $SERVICES; do
  ERROR_COUNT=$(aws logs filter-log-events \
    --log-group-name ecs/blue/$ENV/$SERVICE \
    --start-time $(date -u -d '1 hour ago' '+%s')000 \
    --filter-pattern "ERROR" \
    --profile $PROFILE \
    --query 'events | length(@)' \
    --output text 2>/dev/null || echo "0")

  echo "$SERVICE: $ERROR_COUNT errors"
done

# Check CPU and Memory utilization
echo -e "\nResource Utilization (last 30 min avg):"
for SERVICE in $SERVICES; do
  CPU=$(aws cloudwatch get-metric-statistics \
    --namespace AWS/ECS \
    --metric-name CPUUtilization \
    --dimensions Name=ServiceName,Value=$SERVICE Name=ClusterName,Value=$CLUSTER \
    --start-time $(date -u -d '30 minutes ago' --iso-8601) \
    --end-time $(date -u --iso-8601) \
    --period 1800 \
    --statistics Average \
    --profile $PROFILE \
    --query 'Datapoints[0].Average' \
    --output text 2>/dev/null || echo "N/A")

  MEM=$(aws cloudwatch get-metric-statistics \
    --namespace AWS/ECS \
    --metric-name MemoryUtilization \
    --dimensions Name=ServiceName,Value=$SERVICE Name=ClusterName,Value=$CLUSTER \
    --start-time $(date -u -d '30 minutes ago' --iso-8601) \
    --end-time $(date -u --iso-8601) \
    --period 1800 \
    --statistics Average \
    --profile $PROFILE \
    --query 'Datapoints[0].Average' \
    --output text 2>/dev/null || echo "N/A")

  echo "$SERVICE - CPU: ${CPU}%, Memory: ${MEM}%"
done

# Check for recent task failures
echo -e "\nRecent Task Failures:"
for SERVICE in $SERVICES; do
  STOPPED_TASKS=$(aws ecs list-tasks \
    --cluster $CLUSTER \
    --service-name $SERVICE \
    --desired-status STOPPED \
    --profile $PROFILE \
    --query 'taskArns | length(@)' \
    --output text)

  echo "$SERVICE: $STOPPED_TASKS stopped tasks in history"
done
```

### Sidekiq Queue Monitor

```bash
#!/bin/bash
# sidekiq-monitor.sh

echo "Sidekiq Queue Monitor"
echo "===================="

qumis services exec api \
  --env prod \
  --reason "Monitor Sidekiq queues" \
  --confirm prod \
  -- rails runner "
    require 'sidekiq/api'

    stats = Sidekiq::Stats.new
    puts 'Overall Stats:'
    puts '  Processed: ' + stats.processed.to_s
    puts '  Failed: ' + stats.failed.to_s
    puts '  Busy: ' + stats.workers_size.to_s
    puts '  Enqueued: ' + stats.enqueued.to_s
    puts '  Scheduled: ' + stats.scheduled_size.to_s
    puts '  Retries: ' + stats.retry_size.to_s
    puts '  Dead: ' + stats.dead_size.to_s

    puts '\nQueue Breakdown:'
    Sidekiq::Queue.all.each do |queue|
      puts '  ' + queue.name + ': ' + queue.size.to_s

      # Show oldest job if queue is backed up
      if queue.size > 100
        oldest = queue.first
        if oldest
          puts '    Oldest job: ' + oldest.klass + ' (enqueued ' + oldest.enqueued_at.to_s + ')'
        end
      end
    end

    # Check for stuck jobs
    puts '\nWorkers:'
    workers = Sidekiq::Workers.new
    workers.each do |process_id, thread_id, work|
      runtime = Time.now - Time.at(work['run_at'])
      if runtime > 300  # Jobs running longer than 5 minutes
        puts '  LONG RUNNING: ' + work['queue'] + ' - ' + work['payload']['class'] + ' (' + runtime.to_i.to_s + 's)'
      end
    end
  "
```

## Useful Scripts

### Daily Error Report

```bash
#!/bin/bash
# daily-error-report.sh

LOG_GROUP="/aws/lambda/qumis-api-prod"
PROFILE="qumis_prod"

echo "Daily Error Report - $(date)"
echo "========================"

# Error count by hour
echo -e "\nErrors by Hour:"
for i in {0..23}; do
  START=$(date -u -d "$i hours ago" '+%s')000
  END=$(date -u -d "$(($i-1)) hours ago" '+%s')000

  COUNT=$(aws logs filter-log-events \
    --log-group-name $LOG_GROUP \
    --start-time $START \
    --end-time $END \
    --filter-pattern "ERROR" \
    --profile $PROFILE \
    --query 'events | length(@)' \
    --output text)

  echo "$(date -d "$i hours ago" '+%H:00'): $COUNT errors"
done
```

## Additional Resources

- [CloudWatch Alerts Setup](/internal/engineering/infrastructure/cloudwatch-alerts)
- [AWS CloudWatch Documentation](https://docs.aws.amazon.com/cloudwatch/)
- [Debugging Production Issues](/internal/engineering/troubleshooting/debugging-production)
- [AWS Environments Guide](/internal/engineering/infrastructure/aws-environments)

---

# CloudWatch Alerts

Source: internal/engineering/infrastructure/cloudwatch-alerts

This guide covers how to set up, manage, and respond to CloudWatch alerts for our applications.

## Alert Overview

### Current Alert Structure

| Environment | Critical Alerts | Warning Alerts | Notification Channel |
|------------|-----------------|----------------|---------------------|
| Development | None | Basic | Slack (#dev-alerts) |
| QA | Errors only | Performance | Slack (#qa-alerts) |
| UAT | Same as prod | Same as prod | Slack (#uat-alerts) |
| Production | Full suite | Full suite | PagerDuty + Slack |

## Critical Production Alerts

### Application Health

### High Error Rate

**Alarm**: `qumis-api-prod-high-error-rate`
**Threshold**: >10 errors in 5 minutes
**Action**: Page on-call engineer

```bash
# Create alarm via CLI
aws cloudwatch put-metric-alarm \
  --alarm-name qumis-api-prod-high-error-rate \
  --alarm-description "High error rate in production API" \
  --metric-name Errors \
  --namespace AWS/Lambda \
  --statistic Sum \
  --period 300 \
  --threshold 10 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=FunctionName,Value=qumis-api-prod \
  --evaluation-periods 1 \
  --alarm-actions arn:aws:sns:us-east-1:729033428609:prod-critical-alerts \
  --profile qumis_prod
```

### Function Failures

**Alarm**: `qumis-api-prod-function-failures`
**Threshold**: >5 consecutive failures
**Action**: Page on-call engineer

```bash
aws cloudwatch put-metric-alarm \
  --alarm-name qumis-api-prod-function-failures \
  --alarm-description "Lambda function failing repeatedly" \
  --metric-name Errors \
  --namespace AWS/Lambda \
  --statistic Average \
  --period 60 \
  --threshold 1 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=FunctionName,Value=qumis-api-prod \
  --evaluation-periods 5 \
  --datapoints-to-alarm 5 \
  --alarm-actions arn:aws:sns:us-east-1:729033428609:prod-critical-alerts \
  --profile qumis_prod
```

### Availability

**Alarm**: `qumis-api-prod-availability`
**Threshold**: `<99%` success rate
**Action**: Alert team

```bash
# Using CloudWatch math expressions
aws cloudwatch put-metric-alarm \
  --alarm-name qumis-api-prod-availability \
  --alarm-description "API availability below 99%" \
  --metrics '[
    {
      "Id": "e1",
      "Expression": "(m1-m2)/m1*100"
    },
    {
      "Id": "m1",
      "MetricStat": {
        "Metric": {
          "Namespace": "AWS/Lambda",
          "MetricName": "Invocations",
          "Dimensions": [{"Name": "FunctionName", "Value": "qumis-api-prod"}]
        },
        "Period": 300,
        "Stat": "Sum"
      }
    },
    {
      "Id": "m2",
      "MetricStat": {
        "Metric": {
          "Namespace": "AWS/Lambda",
          "MetricName": "Errors",
          "Dimensions": [{"Name": "FunctionName", "Value": "qumis-api-prod"}]
        },
        "Period": 300,
        "Stat": "Sum"
      }
    }
  ]' \
  --threshold 99 \
  --comparison-operator LessThanThreshold \
  --evaluation-periods 2 \
  --profile qumis_prod
```

### Performance Alerts

### High Latency

**Alarm**: `qumis-api-prod-high-latency`
**Threshold**: >3000ms average duration
**Action**: Alert team

```bash
aws cloudwatch put-metric-alarm \
  --alarm-name qumis-api-prod-high-latency \
  --alarm-description "API response time exceeding 3 seconds" \
  --metric-name Duration \
  --namespace AWS/Lambda \
  --statistic Average \
  --period 300 \
  --threshold 3000 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=FunctionName,Value=qumis-api-prod \
  --evaluation-periods 2 \
  --alarm-actions arn:aws:sns:us-east-1:729033428609:prod-performance-alerts \
  --profile qumis_prod
```

### Throttling

**Alarm**: `qumis-api-prod-throttles`
**Threshold**: >5 throttles
**Action**: Alert team

```bash
aws cloudwatch put-metric-alarm \
  --alarm-name qumis-api-prod-throttles \
  --alarm-description "Lambda function being throttled" \
  --metric-name Throttles \
  --namespace AWS/Lambda \
  --statistic Sum \
  --period 60 \
  --threshold 5 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=FunctionName,Value=qumis-api-prod \
  --evaluation-periods 1 \
  --alarm-actions arn:aws:sns:us-east-1:729033428609:prod-performance-alerts \
  --profile qumis_prod
```

### Memory Usage

**Alarm**: `qumis-api-prod-high-memory`
**Threshold**: >90% memory utilization
**Action**: Alert team

```bash
# Custom metric from application logs
aws cloudwatch put-metric-alarm \
  --alarm-name qumis-api-prod-high-memory \
  --alarm-description "High memory usage detected" \
  --metric-name MemoryUtilization \
  --namespace Qumis/API \
  --statistic Maximum \
  --period 300 \
  --threshold 90 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 2 \
  --alarm-actions arn:aws:sns:us-east-1:729033428609:prod-performance-alerts \
  --profile qumis_prod
```

### Database Alerts

```bash
# RDS CPU utilization
aws cloudwatch put-metric-alarm \
  --alarm-name qumis-rds-prod-high-cpu \
  --alarm-description "RDS CPU usage above 80%" \
  --metric-name CPUUtilization \
  --namespace AWS/RDS \
  --statistic Average \
  --period 300 \
  --threshold 80 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=DBInstanceIdentifier,Value=qumis-prod-db \
  --evaluation-periods 2 \
  --alarm-actions arn:aws:sns:us-east-1:729033428609:prod-database-alerts \
  --profile qumis_prod

# Database connections
aws cloudwatch put-metric-alarm \
  --alarm-name qumis-rds-prod-connections \
  --alarm-description "Database connections near limit" \
  --metric-name DatabaseConnections \
  --namespace AWS/RDS \
  --statistic Average \
  --period 300 \
  --threshold 80 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=DBInstanceIdentifier,Value=qumis-prod-db \
  --evaluation-periods 1 \
  --alarm-actions arn:aws:sns:us-east-1:729033428609:prod-database-alerts \
  --profile qumis_prod
```

## Setting Up New Alerts

### Via AWS Console

### Navigate to CloudWatch

1. Login to AWS Console
2. Go to CloudWatch service
3. Click "Alarms" in left navigation
4. Click "Create alarm"

### Select Metric

1. Click "Select metric"
2. Choose namespace (e.g., AWS/Lambda)
3. Select metric dimension
4. Choose specific metric
5. Click "Select metric"

### Configure Conditions

1. Set statistic (Average, Sum, Maximum, etc.)
2. Choose period (1 minute, 5 minutes, etc.)
3. Set threshold type and value
4. Configure evaluation periods

### Configure Actions

1. Select SNS topic for notifications
2. Add email/SMS/PagerDuty as needed
3. Configure auto-scaling actions if applicable

### Name and Create

1. Provide descriptive name
2. Add detailed description
3. Review and create alarm

### Via AWS CLI

```bash
#!/bin/bash
# create-standard-alarms.sh

FUNCTION_NAME="qumis-api-prod"
SNS_TOPIC="arn:aws:sns:us-east-1:729033428609:prod-alerts"
PROFILE="qumis_prod"

# Error rate alarm
aws cloudwatch put-metric-alarm \
  --alarm-name "${FUNCTION_NAME}-error-rate" \
  --alarm-description "Error rate for ${FUNCTION_NAME}" \
  --metric-name Errors \
  --namespace AWS/Lambda \
  --statistic Sum \
  --period 300 \
  --threshold 10 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=FunctionName,Value=${FUNCTION_NAME} \
  --evaluation-periods 1 \
  --alarm-actions ${SNS_TOPIC} \
  --profile ${PROFILE}

echo "Created error rate alarm for ${FUNCTION_NAME}"

# Duration alarm
aws cloudwatch put-metric-alarm \
  --alarm-name "${FUNCTION_NAME}-duration" \
  --alarm-description "Duration alarm for ${FUNCTION_NAME}" \
  --metric-name Duration \
  --namespace AWS/Lambda \
  --statistic Average \
  --period 300 \
  --threshold 3000 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=FunctionName,Value=${FUNCTION_NAME} \
  --evaluation-periods 2 \
  --alarm-actions ${SNS_TOPIC} \
  --profile ${PROFILE}

echo "Created duration alarm for ${FUNCTION_NAME}"
```

## Alert Response Procedures

### Alert Severity Levels

| Level | Response Time | Action Required | Examples |
|-------|--------------|-----------------|-----------|
| **Critical** | Immediate | Page on-call, immediate investigation | Service down, data loss |
| **High** | 15 minutes | Alert team, investigate soon | High error rate, performance degradation |
| **Medium** | 1 hour | Review and plan fix | Increased latency, warning thresholds |
| **Low** | Next business day | Monitor and track | Minor issues, trending concerns |

### Response Playbook

### Acknowledge Alert

1. Respond in PagerDuty (if paged)
2. Post in #incidents channel
3. Start incident timer

### Initial Assessment

```bash
# Check service health
curl -f https://api.qumis.ai/health

# Check recent errors
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '10 minutes ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod \
  --max-items 20
```

### Investigate Root Cause

- Review CloudWatch logs
- Check recent deployments
- Verify external dependencies
- Review database status

### Take Action

- Apply immediate fix
- Rollback if necessary
- Scale resources if needed
- Contact relevant teams

### Document Resolution

- Update incident ticket
- Post resolution in Slack
- Schedule RCA if needed

## Managing Alert Fatigue

### Alert Tuning

```bash View Alarm History
aws cloudwatch describe-alarm-history \
  --alarm-name qumis-api-prod-high-error-rate \
  --profile qumis_prod \
  --max-records 50
```

```bash Check Alarm State Changes
aws cloudwatch describe-alarms \
  --alarm-names qumis-api-prod-high-error-rate \
  --profile qumis_prod \
  --query 'MetricAlarms[0].StateTransitionReason'
```

### Best Practices

1. **Avoid noise**: Set appropriate thresholds based on historical data
2. **Use composite alarms**: Combine related metrics for better accuracy
3. **Implement delays**: Use evaluation periods to avoid transient spikes
4. **Regular review**: Monthly review of alarm effectiveness
5. **Document context**: Include runbook links in alarm descriptions

## SNS Topics and Subscriptions

### Production SNS Topics

| Topic | Purpose | Subscribers |
|-------|---------|------------|
| prod-critical-alerts | Service down, critical errors | PagerDuty, Slack, Email |
| prod-performance-alerts | Performance degradation | Slack, Email |
| prod-database-alerts | Database issues | Slack, DBA team |
| prod-security-alerts | Security events | Security team, Slack |

### Managing Subscriptions

```bash List SNS Topics
aws sns list-topics --profile qumis_prod
```

```bash List Subscriptions for a Topic
aws sns list-subscriptions-by-topic \
  --topic-arn arn:aws:sns:us-east-1:729033428609:prod-critical-alerts \
  --profile qumis_prod
```

```bash Add Email Subscription
aws sns subscribe \
  --topic-arn arn:aws:sns:us-east-1:729033428609:prod-critical-alerts \
  --protocol email \
  --notification-endpoint your-email@qumis.ai \
  --profile qumis_prod
```

## Integration with External Services

### PagerDuty Integration

```bash
# PagerDuty integration via SNS
aws sns subscribe \
  --topic-arn arn:aws:sns:us-east-1:729033428609:prod-critical-alerts \
  --protocol https \
  --notification-endpoint https://events.pagerduty.com/integration/YOUR_INTEGRATION_KEY/enqueue \
  --profile qumis_prod
```

### Slack Integration

Using AWS Chatbot or Lambda:

```python
# Lambda function for Slack notifications
import json
import urllib3

http = urllib3.PoolManager()

def lambda_handler(event, context):
    url = "YOUR_SLACK_WEBHOOK_URL"
    msg = json.loads(event['Records'][0]['Sns']['Message'])

    slack_message = {
        "text": f"ðŸš¨ CloudWatch Alarm: {msg['AlarmName']}",
        "blocks": [
            {
                "type": "section",
                "text": {
                    "type": "mrkdwn",
                    "text": f"*Alarm:* {msg['AlarmName']}\n*Status:* {msg['NewStateValue']}\n*Reason:* {msg['NewStateReason']}"
                }
            }
        ]
    }

    response = http.request('POST', url,
                          body=json.dumps(slack_message).encode('utf-8'),
                          headers={'Content-Type': 'application/json'})

    return {'statusCode': 200}
```

## Dashboard Creation

### Create Monitoring Dashboard

```bash
# Create dashboard via CLI
aws cloudwatch put-dashboard \
  --dashboard-name QumisProductionDashboard \
  --dashboard-body '{
    "widgets": [
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/Lambda", "Invocations", {"stat": "Sum"}],
            [".", "Errors", {"stat": "Sum"}],
            [".", "Duration", {"stat": "Average"}]
          ],
          "period": 300,
          "stat": "Average",
          "region": "us-east-1",
          "title": "Lambda Performance"
        }
      }
    ]
  }' \
  --profile qumis_prod
```

## Maintenance and Review

### Monthly Alert Review

```bash
#!/bin/bash
# alert-review.sh

echo "Monthly Alert Review - $(date)"
echo "=========================="

# Get all alarms
aws cloudwatch describe-alarms \
  --profile qumis_prod \
  --query 'MetricAlarms[*].[AlarmName,StateValue,StateUpdatedTimestamp]' \
  --output table

# Get alarm statistics
echo -e "\nAlarm trigger count (last 30 days):"
aws cloudwatch describe-alarm-history \
  --start-date $(date -u -d '30 days ago' --iso-8601) \
  --end-date $(date -u --iso-8601) \
  --profile qumis_prod \
  --query 'AlarmHistoryItems[?HistoryItemType==`StateUpdate`]' \
  --output json | jq -r '.[].AlarmName' | sort | uniq -c | sort -rn
```

## Additional Resources

- [CloudWatch Monitoring](/internal/engineering/infrastructure/cloudwatch-monitoring)
- [Production Deployment](/internal/engineering/deployment/production-deployment)
- [Incident Response Runbook](/internal/engineering/troubleshooting/debugging-production)
- [AWS CloudWatch Alarms Documentation](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html)

---

# Common Issues

Source: internal/engineering/troubleshooting/common-issues

This guide provides solutions to common issues you might encounter while working with the Qumis platform.

## Development Issues

### Local Environment

### Rails server won't start

**Symptoms**: Rails server fails to start, bundle errors

**Solutions**:

```bash
# Update dependencies
bundle install

# Check Ruby version
ruby --version
rbenv install 3.2.2  # If wrong version

# Database issues
rails db:create
rails db:migrate
rails db:seed

# Clear cache
rails tmp:clear
rails cache:clear
```

### Database connection errors

**Symptoms**: Can't connect to PostgreSQL, connection refused

**Solutions**:

```bash
# Check PostgreSQL is running
brew services list | grep postgresql

# Start PostgreSQL
brew services start postgresql@14

# Check database exists
psql -l | grep qumis

# Create database
rails db:create

# Check database.yml configuration
cat config/database.yml
```

### Node/npm issues

**Symptoms**: npm install fails, version mismatch

**Solutions**:

```bash
# Check Node version
node --version
nvm use 20  # Use correct version

# Clear npm cache
npm cache clean --force

# Remove node_modules and reinstall
rm -rf node_modules package-lock.json
npm install

# Use correct registry
npm config set registry https://registry.npmjs.org/
```

### Git and Version Control

### Can't push to GitHub

**Symptoms**: Permission denied, authentication failed

**Solutions**:

```bash
# Check GitHub authentication
gh auth status

# Re-authenticate
gh auth login

# Check remote URL
git remote -v

# Update to HTTPS if using SSH without keys
git remote set-url origin https://github.com/qumisinc/repo-name.git

# Check branch protection
# You might need PR approval to merge to main
```

### Merge conflicts

**Symptoms**: Can't merge PR, conflicts with main

**Solutions**:

```bash
# Update your branch
git checkout main
git pull origin main
git checkout your-branch
git rebase main

# Resolve conflicts
# Edit conflicted files
git add .
git rebase --continue

# Or merge instead of rebase
git merge main
# Resolve conflicts
git add .
git commit
```

## qumis-cli Issues

### qumis command not found

**Problem**: Command not recognized

**Solution**:

```bash
# Check installation
which qumis

# Add to PATH
echo 'export PATH=$PATH:$(go env GOPATH)/bin' >> ~/.zshrc
source ~/.zshrc

# Reinstall
cd /path/to/qumis-cli
make deploy
```

### AWS authentication failures

**Problem**: Can't access AWS resources

**Solution**:

```bash
# Re-authenticate
qumis aws login dev

# Check SSO session
aws sso login --profile qumis_dev

# Verify credentials
aws sts get-caller-identity --profile qumis_dev

# Clear cached credentials
rm -rf ~/.aws/sso/cache/*
```

### GitHub token expired

**Problem**: qumis GitHub operations failing

**Solution**:

```bash
# Generate new token at GitHub
# https://github.com/settings/tokens

# Update qumis config
qumis config github.token <new-token>

# Verify
qumis doctor
```

## ECS Issues

### ECS service not starting

**Symptoms**: Tasks failing to start, service stuck in pending

**Solutions**:

```bash
# Check service events (blue cluster)
aws ecs describe-services \
  --cluster blue-prod \
  --services api \
  --profile qumis_prod \
  --query 'services[0].events[:10]'

# Check task failures
aws ecs list-tasks \
  --cluster blue-prod \
  --service-name api \
  --desired-status STOPPED \
  --profile qumis_prod

# Get task failure reason
TASK_ARN=$(aws ecs list-tasks --cluster blue-prod --service-name api --desired-status STOPPED --profile qumis_prod --query 'taskArns[0]' --output text)
aws ecs describe-tasks \
  --cluster blue-prod \
  --tasks $TASK_ARN \
  --profile qumis_prod \
  --query 'tasks[0].stoppedReason'

# Common fixes:
# - Check container image exists in ECR
# - Verify IAM task execution role permissions
# - Check memory/CPU limits are sufficient
# - Review health check configuration
```

### Container keeps restarting

**Symptoms**: Container health checks failing, continuous restarts

**Solutions**:

```bash
# Check container logs (blue cluster)
aws logs tail ecs/blue/prod/api --profile qumis_prod --follow

# Check health check configuration
aws ecs describe-task-definition \
  --task-definition api-prod \
  --profile qumis_prod \
  --query 'taskDefinition.containerDefinitions[0].healthCheck'

# Monitor memory usage
aws cloudwatch get-metric-statistics \
  --namespace AWS/ECS \
  --metric-name MemoryUtilization \
  --dimensions Name=ServiceName,Value=api Name=ClusterName,Value=blue-prod \
  --start-time $(date -u -d '1 hour ago' --iso-8601) \
  --end-time $(date -u --iso-8601) \
  --period 300 \
  --statistics Average,Maximum \
  --profile qumis_prod

# Solutions:
# - Increase health check grace period
# - Adjust memory/CPU limits
# - Fix application startup issues
# - Check for missing environment variables
```

### Sidekiq jobs not processing

**Symptoms**: Jobs stuck in queue, Sidekiq not picking up work

**Solutions**:

```bash
# Check Sidekiq service status (blue cluster)
aws ecs describe-services \
  --cluster blue-prod \
  --services sidekiq \
  --profile qumis_prod \
  --query 'services[0].[status,runningCount,desiredCount]'

# Check Sidekiq logs
aws logs tail ecs/blue/prod/sidekiq \
  --profile qumis_prod \
  --follow

# Check Redis connectivity
qumis services exec api \
  --env prod \
  --reason "Check Redis connection" \
  --confirm prod \
  -- rails runner "puts Sidekiq.redis { |c| c.ping }"

# Check queue sizes
qumis services exec api \
  --env prod \
  --reason "Check Sidekiq queues" \
  --confirm prod \
  -- rails runner "
    require 'sidekiq/api'
    stats = Sidekiq::Stats.new
    puts 'Processed: ' + stats.processed.to_s
    puts 'Failed: ' + stats.failed.to_s
    puts 'Queues: ' + Sidekiq::Queue.all.map { |q| q.name + ': ' + q.size.to_s }.join(', ')
  "

# Restart Sidekiq service if needed (blue cluster)
aws ecs update-service \
  --cluster blue-prod \
  --service sidekiq \
  --force-new-deployment \
  --profile qumis_prod
```

## Deployment Issues

### Build Failures

### GitHub Actions workflow failing

**Symptoms**: Deployment workflow fails to complete

**Solutions**:

### Check GitHub Actions page for error details

Review the workflow run logs to identify the specific failure point

### Apply common fixes

```bash
# Retry deployment
qumis deploy api --env dev --reason "Retry after fix"

# Check workflow file exists
git pull origin main
ls .github/workflows/

# Verify branch has latest changes
git fetch --all
git rebase origin/main
```

### Docker build errors

**Symptoms**: Container fails to build

**Solutions**:

```bash
# Clear Docker cache
docker system prune -a

# Check Dockerfile
docker build -t test .

# Test locally
docker run -it test /bin/bash

# Check base image availability
docker pull ruby:3.2.2-alpine
```

### Runtime Errors

### Lambda function timeout

**Symptoms**: Function times out after 30 seconds

**Solutions**:

```bash
# Check function configuration
aws lambda get-function-configuration \
  --function-name qumis-api-prod \
  --profile qumis_prod

# Increase timeout (via Infrastructure as Code)
# Update serverless.yml or terraform

# Check for slow queries
qumis services exec api \
  --env prod \
  --reason "Check slow queries" \
  --confirm prod \
  -- rails runner "ActiveRecord::Base.logger = Logger.new(STDOUT); User.all.to_a"
```

### Memory errors

**Symptoms**: Lambda running out of memory

**Solutions**:

```bash
# Check current memory setting
aws lambda get-function-configuration \
  --function-name qumis-api-prod \
  --profile qumis_prod \
  --query 'MemorySize'

# Monitor memory usage
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --filter-pattern "[REPORT]" \
  --profile qumis_prod \
  --query 'events[*].message' \
  --output text | grep "Memory"

# Solutions:
# 1. Increase Lambda memory allocation
# 2. Optimize code to use less memory
# 3. Process in batches
```

## Database Issues

### Connection pool exhausted

**Symptoms**: ActiveRecord::ConnectionTimeoutError

**Solutions**:

```bash
# Check current connections
qumis services exec api \
  --env prod \
  --reason "Check DB connections" \
  --confirm prod \
  -- rails runner "puts ActiveRecord::Base.connection_pool.stat"

# Clear stale connections
qumis services exec api \
  --env prod \
  --reason "Clear stale connections" \
  --confirm prod \
  -- rails runner "ActiveRecord::Base.clear_active_connections!"

# Long-term fix: Adjust pool size in database.yml
```

### Migration failures

**Symptoms**: PG::Error during migration

**Solutions**:

```bash
# Check migration status
qumis services exec api --env uat -- rails db:migrate:status

# Run specific migration
qumis services exec api --env uat -- rails db:migrate:up VERSION=20240101120000

# Rollback if needed
qumis services exec api --env uat -- rails db:rollback

# Fix and retry
qumis services exec api --env uat -- rails db:migrate
```

### Slow queries

**Symptoms**: Timeouts, high response times

**Solutions**:

```bash
# Enable query logging
qumis services exec api \
  --env prod \
  --reason "Debug slow queries" \
  --confirm prod \
  -- rails console
> ActiveRecord::Base.logger = Logger.new(STDOUT)
> User.includes(:posts).limit(10).to_a

# Check for missing indexes
# Add indexes in migration
# Use includes() to avoid N+1 queries
```

## API and Integration Issues

### CORS errors

**Symptoms**: Cross-origin request blocked

**Solutions**:

```ruby
# Check CORS configuration in Rails
# config/initializers/cors.rb
Rails.application.config.middleware.insert_before 0, Rack::Cors do
  allow do
    origins 'https://app.qumis.ai'
    resource '*',
      headers: :any,
      methods: [:get, :post, :put, :patch, :delete, :options]
  end
end

# Restart application after changes
```

### Authentication failures

**Symptoms**: 401 Unauthorized errors

**Solutions**:

```bash
# Check JWT token expiration
qumis services exec api \
  --env prod \
  --reason "Check auth config" \
  --confirm prod \
  -- rails runner "puts ENV['JWT_SECRET'].present?"

# Verify token generation
# Check authentication middleware
# Ensure cookies are being set correctly
```

### Rate limiting

**Symptoms**: 429 Too Many Requests

**Solutions**:

```bash
# Check rate limit configuration
# Implement exponential backoff
# Use caching to reduce API calls
# Consider increasing limits for production
```

## Monitoring and Alerting Issues

### Missing CloudWatch logs

**Symptoms**: Logs not appearing in CloudWatch

**Solutions**:

```bash
# Check Lambda has CloudWatch permissions
aws lambda get-function-configuration \
  --function-name qumis-api-prod \
  --profile qumis_prod \
  --query 'Role'

# Check log group exists
aws logs describe-log-groups \
  --log-group-name-prefix /aws/lambda/qumis \
  --profile qumis_prod

# Create log group if missing
aws logs create-log-group \
  --log-group-name /aws/lambda/qumis-api-prod \
  --profile qumis_prod
```

### Alerts not firing

**Symptoms**: No notifications for issues

**Solutions**:

```bash
# Check alarm state
aws cloudwatch describe-alarms \
  --alarm-names qumis-api-prod-errors \
  --profile qumis_prod

# Check SNS subscriptions
aws sns list-subscriptions-by-topic \
  --topic-arn arn:aws:sns:us-east-1:729033428609:prod-alerts \
  --profile qumis_prod

# Test SNS topic
aws sns publish \
  --topic-arn arn:aws:sns:us-east-1:729033428609:prod-alerts \
  --message "Test alert" \
  --subject "Test" \
  --profile qumis_prod
```

## Quick Diagnostic Commands

### Health Check Script

```bash
#!/bin/bash
# health-check.sh

echo "Running system health check..."

# Check qumis-cli
echo -n "qumis-cli: "
qumis --version || echo "NOT INSTALLED"

# Check AWS access
echo -n "AWS Dev: "
aws sts get-caller-identity --profile qumis_dev &>/dev/null && echo "OK" || echo "FAIL"

echo -n "AWS Prod: "
aws sts get-caller-identity --profile qumis_prod &>/dev/null && echo "OK" || echo "FAIL"

# Check GitHub
echo -n "GitHub: "
gh auth status &>/dev/null && echo "OK" || echo "FAIL"

# Check services
for ENV in dev qa uat prod; do
  echo -n "API $ENV: "
  if [ "$ENV" = "prod" ]; then
    curl -sf https://api.qumis.ai/health &>/dev/null && echo "OK" || echo "DOWN"
  else
    qumis services info api --env $ENV &>/dev/null && echo "OK" || echo "ERROR"
  fi
done
```

### Debug Information Collector

```bash
#!/bin/bash
# collect-debug-info.sh

OUTPUT="debug_$(date +%Y%m%d_%H%M%S).txt"

echo "Collecting debug information..." > $OUTPUT

echo -e "\n=== System Info ===" >> $OUTPUT
uname -a >> $OUTPUT

echo -e "\n=== qumis-cli ===" >> $OUTPUT
qumis --version >> $OUTPUT
qumis doctor >> $OUTPUT

echo -e "\n=== AWS Configuration ===" >> $OUTPUT
aws configure list >> $OUTPUT

echo -e "\n=== Recent Errors (Prod) ===" >> $OUTPUT
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '1 hour ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod \
  --max-items 10 >> $OUTPUT 2>&1

echo "Debug information saved to $OUTPUT"
```

## Getting Help

> **Info:** If you can't resolve an issue, follow these escalation steps:
>
> 1. **Search existing documentation** - Check other guides in this documentation
> 2. **Ask in Slack** - Post in #engineering with error details
> 3. **Check runbooks** - Look for specific runbooks for your service
> 4. **Escalate if critical** - Page on-call for production issues

### Information to Provide

> **Note:** When asking for help, include:
>
> - Environment (dev/qa/uat/prod)
> - Error message (full stack trace)
> - Recent changes (deployments, config changes)
> - Steps to reproduce
> - What you've already tried

## Additional Resources

- [Debugging Production](/internal/engineering/troubleshooting/debugging-production)
- [CloudWatch Monitoring](/internal/engineering/infrastructure/cloudwatch-monitoring)
- [Rollback Procedures](/internal/engineering/deployment/rollback-procedures)
- [qumis-cli Reference](/internal/engineering/operations/qumis-cli-reference)

---

# Debugging Production

Source: internal/engineering/troubleshooting/debugging-production

> **Warning:** **Production debugging requires extreme caution**. Always:
>
> - Get approval for production access
> - Use read-only operations when possible
> - Document all actions taken
> - Have a rollback plan ready

## Production Debugging Principles

### Safety First

> **Note:** Follow these critical safety principles when debugging production:
>
> 1. **Read-only by default** - Start with non-destructive operations
> 2. **Audit everything** - All commands are logged with reasons
> 3. **Test in UAT first** - Reproduce issues in UAT when possible
> 4. **Pair debugging** - Have another engineer review critical operations
> 5. **Time-box investigations** - Set limits to prevent extended downtime

## Initial Assessment

### Quick Health Check

```bash
# 1. Check service status
curl -f https://api.qumis.ai/health || echo "Service unhealthy"

# 2. Check ECS service status (blue cluster)
aws ecs describe-services \
  --cluster blue-prod \
  --services api web sidekiq \
  --profile qumis_prod \
  --query 'services[*].[serviceName,status,runningCount,desiredCount]' \
  --output table

# 3. Check recent errors across all ECS services (last 15 minutes)
for SERVICE in api web sidekiq; do
  echo "=== $SERVICE errors ==="
  aws logs filter-log-events \
    --log-group-name ecs/blue/prod/$SERVICE \
    --start-time $(date -u -d '15 minutes ago' '+%s')000 \
    --filter-pattern "ERROR" \
    --profile qumis_prod \
    --max-items 10
done

# 4. Check ECS cluster metrics
aws cloudwatch get-metric-statistics \
  --namespace AWS/ECS \
  --metric-name CPUUtilization \
  --dimensions Name=ServiceName,Value=api Name=ClusterName,Value=blue-prod \
  --start-time $(date -u -d '1 hour ago' --iso-8601) \
  --end-time $(date -u --iso-8601) \
  --period 300 \
  --statistics Average,Maximum \
  --profile qumis_prod
```

### Incident Timeline

### Establish Timeline

```bash
# Find when issues started
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '2 hours ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod \
  --query 'events[0].timestamp' \
  --output text | xargs -I {} date -d @{}
```

### Check Recent Changes

```bash
# Recent deployments
git log --oneline --grep="Deploy to prod" -5

# Check GitHub Actions
gh run list --workflow deploy.yml --limit 5

# Infrastructure changes
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=EventName,AttributeValue=UpdateFunctionConfiguration \
  --profile qumis_prod \
  --max-items 10
```

### Correlate Events

Match error timing with:

- Deployment times
- Configuration changes
- Traffic spikes
- External service issues

## Safe Debugging Techniques

### Read-Only Console Access

```bash
# Use sandbox mode for safety
qumis services exec api \
  --env prod \
  --reason "Debug issue #12345 - READ ONLY" \
  --confirm prod \
  -- rails console --sandbox

# In console:
> User.count  # Safe read
> User.where(created_at: 1.hour.ago..Time.now).count
> # Any changes will be rolled back on exit
```

### Query Specific Data

```bash
# Run specific queries without console
qumis services exec api \
  --env prod \
  --reason "Check user status for support ticket #789" \
  --confirm prod \
  -- rails runner "
    user = User.find_by(email: 'user@example.com')
    if user
      puts 'User found:'
      puts '  ID: ' + user.id.to_s
      puts '  Status: ' + user.status
      puts '  Created: ' + user.created_at.to_s
      puts '  Last login: ' + user.last_sign_in_at.to_s
    else
      puts 'User not found'
    end
  "
```

### Trace Request Flow

```bash
# Find specific request in logs
REQUEST_ID="abc-123-def-456"

# Get all logs for request
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --filter-pattern "\"$REQUEST_ID\"" \
  --profile qumis_prod \
  --query 'events[*].message' \
  --output text

# Follow request through services
for SERVICE in api web llm; do
  echo "=== $SERVICE ==="
  aws logs filter-log-events \
    --log-group-name /aws/lambda/qumis-$SERVICE-prod \
    --filter-pattern "\"$REQUEST_ID\"" \
    --profile qumis_prod \
    --max-items 10
done
```

## Common Production Issues

### High Error Rate

### Diagnosis

```bash
# Get error breakdown
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '30 minutes ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod \
  --query 'events[*].message' \
  --output text | \
  grep -oE "([A-Za-z]+Error|[A-Za-z]+Exception)" | \
  sort | uniq -c | sort -rn

# Check for pattern
aws logs insights start-query \
  --log-group-names /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '1 hour ago' '+%s') \
  --end-time $(date -u '+%s') \
  --query-string '
    fields @timestamp, @message
    | filter @message like /ERROR/
    | stats count() by bin(5m)
  ' \
  --profile qumis_prod
```

### Common Causes

**Database Issues**:

```bash
# Check database connectivity
qumis services exec api \
  --env prod \
  --reason "Check DB connection" \
  --confirm prod \
  -- rails runner "puts ActiveRecord::Base.connection.active?"

# Check connection pool
qumis services exec api \
  --env prod \
  --reason "Check connection pool" \
  --confirm prod \
  -- rails runner "puts ActiveRecord::Base.connection_pool.stat"
```

**External Service Issues**:

```bash
# Test external APIs
qumis services exec api \
  --env prod \
  --reason "Test external service connectivity" \
  --confirm prod \
  -- rails runner "
    require 'net/http'
    uri = URI('https://external-api.example.com/health')
    response = Net::HTTP.get_response(uri)
    puts 'External API Status: ' + response.code
  "
```

### Performance Degradation

### Identify Bottlenecks

```bash
# Check Lambda duration
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Duration \
  --dimensions Name=FunctionName,Value=qumis-api-prod \
  --start-time $(date -u -d '2 hours ago' --iso-8601) \
  --end-time $(date -u --iso-8601) \
  --period 300 \
  --statistics Average,Maximum,Minimum \
  --profile qumis_prod

# Find slow endpoints
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --filter-pattern "[SLOW]" \
  --profile qumis_prod \
  --query 'events[*].message' \
  --output text | \
  grep -oE "POST|GET|PUT|DELETE [^ ]+" | \
  sort | uniq -c | sort -rn
```

### Database Performance

```bash
# Check for slow queries
qumis services exec api \
  --env prod \
  --reason "Identify slow queries" \
  --confirm prod \
  -- rails runner "
    ActiveRecord::Base.logger = Logger.new(STDOUT)
    ActiveRecord::Base.logger.level = Logger::DEBUG

    # Run suspected slow query with timing
    start = Time.now
    User.includes(:posts, :comments).where(active: true).limit(100).to_a
    puts 'Query time: ' + (Time.now - start).to_s + ' seconds'
  "

# Check for missing indexes
qumis services exec api \
  --env prod \
  --reason "Check indexes" \
  --confirm prod \
  -- rails runner "
    ActiveRecord::Base.connection.tables.each do |table|
      indexes = ActiveRecord::Base.connection.indexes(table)
      puts table + ': ' + indexes.map(&:name).join(', ')
    end
  "
```

### Memory Issues

```bash
# Check memory usage patterns
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --filter-pattern "REPORT" \
  --profile qumis_prod \
  --query 'events[*].message' \
  --output text | \
  grep "Memory Size\|Max Memory Used" | \
  tail -20

# Check for memory leaks
qumis services exec api \
  --env prod \
  --reason "Check memory usage" \
  --confirm prod \
  -- rails runner "
    puts 'Initial memory: ' + (\`ps -o rss= -p \#{Process.pid}\`.to_i / 1024).to_s + ' MB'

    # Perform operation
    1000.times { User.first }

    GC.start
    puts 'After GC: ' + (\`ps -o rss= -p \#{Process.pid}\`.to_i / 1024).to_s + ' MB'
  "
```

### Data Inconsistencies

> **Warning:** Be extremely careful when investigating data issues. Never modify production data without approval and backups.

```bash
# Investigate data issue (READ ONLY)
qumis services exec api \
  --env prod \
  --reason "Investigate data inconsistency - ticket #456" \
  --confirm prod \
  -- rails console --sandbox

# In console:
> # Find problematic records
> problematic = User.left_joins(:profile).where(profiles: {id: nil})
> puts "Found #{problematic.count} users without profiles"
>
> # Analyze pattern
> problematic.limit(5).each do |user|
>   puts "User #{user.id}: created #{user.created_at}, status: #{user.status}"
> end
>
> # DO NOT FIX IN PRODUCTION - Create fix script for review
```

## Advanced Debugging Tools

### CloudWatch Insights

```sql
-- Find specific error patterns
fields @timestamp, @message, @requestId
| filter @message like /ActiveRecord::RecordNotFound/
| sort @timestamp desc
| limit 20

-- Analyze request patterns
fields @timestamp, @requestId, @duration
| filter @type = "REPORT"
| stats avg(@duration) as avg_duration,
        max(@duration) as max_duration,
        count() as request_count
by bin(5m)

-- Find memory issues
fields @timestamp, @maxMemoryUsed, @memorySize
| filter @type = "REPORT"
| filter @maxMemoryUsed / @memorySize > 0.9
| sort @timestamp desc
```

### X-Ray Tracing

```bash
# Get trace summaries
aws xray get-trace-summaries \
  --start-time $(date -u -d '1 hour ago' --iso-8601) \
  --end-time $(date -u --iso-8601) \
  --filter-expression "service(\"qumis-api-prod\") AND error" \
  --profile qumis_prod

# Get detailed trace
aws xray get-traces \
  --trace-ids "1-5f4d6e7c-1234567890abcdef" \
  --profile qumis_prod
```

### Custom Debug Scripts

```bash
#!/bin/bash
# production-debug.sh

set -e

REASON="$1"
if [ -z "$REASON" ]; then
  echo "Usage: $0 'reason for debugging'"
  exit 1
fi

echo "Starting production debug session..."
echo "Reason: $REASON"

# Create debug report
REPORT="debug_$(date +%Y%m%d_%H%M%S).txt"

echo "=== Production Debug Report ===" > $REPORT
echo "Date: $(date)" >> $REPORT
echo "Reason: $REASON" >> $REPORT
echo "" >> $REPORT

# Collect metrics
echo "=== Error Count (Last Hour) ===" >> $REPORT
aws logs filter-log-events \
  --log-group-name /aws/lambda/qumis-api-prod \
  --start-time $(date -u -d '1 hour ago' '+%s')000 \
  --filter-pattern "ERROR" \
  --profile qumis_prod \
  --query 'length(events)' \
  --output text >> $REPORT

# Add more debug commands as needed

echo "Debug report saved to $REPORT"
```

## Production Fix Workflow

### Emergency Fixes

### Identify Root Cause

Use read-only debugging to understand the issue

### Develop Fix

Create fix in development environment and test thoroughly

### Test in UAT

```bash
# Deploy to UAT
qumis deploy api --env uat --reason "Test fix for production issue"

# Verify fix
qumis services exec api --env uat -- rails runner "# test script"
```

### Deploy to Production

```bash
# Deploy fix
qumis deploy api \
  --env prod \
  --reason "HOTFIX: Issue #123 - [description]" \
  --confirm prod

# Monitor closely
aws logs tail /aws/lambda/qumis-api-prod --profile qumis_prod --follow
```

### Verify Resolution

Confirm issue is resolved and no new issues introduced

## Post-Incident Actions

### Documentation

> **Info:** Create incident report with:
>
> - Timeline of events
> - Root cause analysis
> - Actions taken
> - Lessons learned
> - Prevention measures

### Monitoring Improvements

```bash
# Add new alarm for detected issue
aws cloudwatch put-metric-alarm \
  --alarm-name "qumis-api-prod-[specific-issue]" \
  --alarm-description "Alert for [issue description]" \
  --metric-name Errors \
  --namespace AWS/Lambda \
  --statistic Sum \
  --period 300 \
  --threshold 5 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=FunctionName,Value=qumis-api-prod \
  --evaluation-periods 1 \
  --alarm-actions arn:aws:sns:us-east-1:729033428609:prod-alerts \
  --profile qumis_prod
```

## Best Practices

> **Tip:** Follow these best practices for safe production debugging:
>
> 1. **Always use `--reason` flag** for audit trail
> 2. **Start with read-only operations**
> 3. **Test fixes in lower environments first**
> 4. **Document all debugging steps**
> 5. **Set time limits for debugging sessions**
> 6. **Have rollback plan ready**
> 7. **Communicate with team throughout**
> 8. **Create runbooks for common issues**

## Additional Resources

- [Common Issues Guide](/internal/engineering/troubleshooting/common-issues)
- [CloudWatch Monitoring](/internal/engineering/infrastructure/cloudwatch-monitoring)
- [Rollback Procedures](/internal/engineering/deployment/rollback-procedures)
- [Production Deployment](/internal/engineering/deployment/production-deployment)
